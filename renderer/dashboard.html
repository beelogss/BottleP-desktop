<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="assets/dashboard.css">
    <link rel="stylesheet" href="assets/manageuser.css"> <!-- Include the CSS for manageuser -->
    <script src="https://kit.fontawesome.com/3980f875bb.js" crossorigin="anonymous"></script>
    <script src="assets/manage-user.js" defer></script>
</head>

<body>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <h2>&nbsp;&nbsp;Dashboard</h2>
            <a href="#" onclick="showContent('dashboard')"><i class="fa-solid fa-chart-line"></i>&nbsp;&nbsp;&nbsp;Dashboard</a>
            <a href="#" onclick="showContent('manage-user')"><i class="fa-solid fa-users-line"></i>&nbsp;&nbsp;&nbsp;Manage User</a>
            <a href="#" onclick="showContent('leaderboard')"><i class="fa-solid fa-ranking-star"></i>&nbsp;&nbsp;&nbsp;Leader Board</a>
            <a href="#" onclick="showContent('points-allocation')"><i class="fa-solid fa-coins"></i>&nbsp;&nbsp;&nbsp;Points Allocation</a>
            <a href="#" onclick="showContent('rewards')"><i class="fa-solid fa-gift"></i>&nbsp;&nbsp;&nbsp;Rewards</a>
            <a href="#" onclick="showContent('pet-bottles')"><i class="fa-solid fa-bottle-water"></i>&nbsp;&nbsp;&nbsp;PET Bottles</a>
            <a href="#" onclick="showContent('manage-rewards')"><i class="fa-solid fa-gift"></i>&nbsp;&nbsp;&nbsp;Manage Rewards</a>
            <a href="#" onclick="showContent('sales')"><i class="fa-solid fa-bottle-water"></i>&nbsp;&nbsp;&nbsp;Sales</a>
            <a href="#" onclick="showContent('settings')"><i class="fa-solid fa-gear"></i>&nbsp;&nbsp;&nbsp;Settings</a>
            <a href="index.html"><i class="fa-solid fa-right-from-bracket"></i>&nbsp;&nbsp;&nbsp;Logout</a>
        </div>

        <div class="content" id="content">
            <!-- Content will be displayed here -->
        </div>
    </div>

    <script>
        async function showContent(section) {
            const content = document.getElementById('content');
            switch (section) {
                case 'dashboard':
                    content.innerHTML = `
                        <div class="grid-container">
                            <div class="grid-item box1" id="user-count-container">
                                <div class="user-count-text" id="user-count-text">Total Users:</div>
                                <div class="user-count-number" id="user-count">Loading...</div>
                            </div>
                            <div class="grid-item box2" id="claimed-rewards-container">
                                <div class="claimed-rewards-text" id="claimed-rewards-text">Total Claimed Rewards:</div>
                                <div class="claimed-rewards-number" id="claimed-rewards-count">Loading...</div>
                            </div>
                            <div class="grid-item box3" id="bottle-contribution-container">
                                <div class="bottle-contribution-text" id="bottle-count-text">Total Bottle Contribution:</div>
                                <div class="bottle-contribution-number" id="bottle-count">Loading...</div>
                            </div>
                            <div class="grid-item full">
                                <table id="userTable">
                                    <thead>
                                        <tr>
                                            <th>Rank Number</th>
                                            <th>Student Number</th>
                                            <th>Full Name</th>
                                            <th>Bottle Contribution</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                            <div class="grid-item wide">
                                <button onclick="openModal()">Start Scan</button>
                            </div>
                        </div>`;
                    displayUserCount();
                    displayClaimedRewardsCount();
                    displayBottleCount();
                    fetchData();
                    break;
                case 'manage-user':
                const response = await fetch('manageuser.html');
                    const html = await response.text();
                    content.innerHTML = html;
                    executeScripts(content);
                    break;
                case 'leaderboard':
                    content.innerHTML = '<h1>Leader Board</h1>';
                    break;
                case 'points-allocation':
                    content.innerHTML = '<h1>Points Allocation</h1>';
                    break;
                case 'rewards':
                    content.innerHTML = '<h1>Rewards</h1>';
                    break;
                case 'pet-bottles':
                    content.innerHTML = '<h1>PET Bottles</h1>';
                    break;
                case 'manage-rewards':
                    content.innerHTML = '<h1>Manage Rewards</h1>';
                    break;
                case 'sales':
                    content.innerHTML = '<h1>Sales</h1>';
                    break;
                case 'settings':
                    content.innerHTML = '<h1>Settings</h1>';
                    break;
                default:
                    content.innerHTML = '';
            }
        }
        showContent('dashboard');

        function executeScripts(container) {
            const scripts = container.querySelectorAll('script');
            scripts.forEach(script => {
                const newScript = document.createElement('script');
                newScript.textContent = script.textContent;
                document.body.appendChild(newScript);
                document.body.removeChild(newScript);
            });
        }

        showContent('dashboard');

        async function displayUserCount() {
            try {
                const userCount = await window.electronAPI.getUserCount();
                document.getElementById('user-count-text').textContent = 'Total Users:';
                document.getElementById('user-count').textContent = userCount;
            } catch (error) {
                console.error('Error fetching user count:', error);
                document.getElementById('user-count-text').textContent = 'Total Users:';
                document.getElementById('user-count').textContent = 'Error loading user count';
            }
        }

        async function displayClaimedRewardsCount() {
            try {
                const claimedCount = await window.electronAPI.getClaimedRewardsCount();
                document.getElementById('claimed-rewards-text').textContent = 'Total Claimed Rewards:';
                document.getElementById('claimed-rewards-count').textContent = claimedCount;
            } catch (error) {
                console.error('Error fetching claimed rewards count:', error);
                document.getElementById('claimed-rewards-text').textContent = 'Total Claimed Rewards:';
                document.getElementById('claimed-rewards-count').textContent = 'Error loading claimed rewards count';
            }
        }

        async function displayBottleCount() {
            try {
                const bottleCount = await window.electronAPI.getTotalBottleCount();
                document.getElementById('bottle-count-text').textContent = 'Total Bottle Count:';
                document.getElementById('bottle-count').textContent = bottleCount;
            } catch (error) {
                console.error('Error fetching bottle count:', error);
                document.getElementById('bottle-count-text').textContent = 'Total Bottle Count:';
                document.getElementById('bottle-count').textContent = 'Error loading bottle count';
            }
        }

        async function fetchData() {
            try {
                const data = await window.electronAPI.getUserPoints();
                console.log('Data received in renderer:', data);
                const aggregatedData = aggregateData(data);
                updateTable(aggregatedData); 
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        function aggregateData(data) {
            const aggregatedData = {};

            data.forEach(user => {
                if (!aggregatedData[user.studentNumber]) {
                    aggregatedData[user.studentNumber] = {
                        studentNumber: user.studentNumber,
                        name: user.name,
                        bottleCount: 0,
                        totalPoints: 0
                    };
                }
                aggregatedData[user.studentNumber].bottleCount += user.bottleCount || 0;
                aggregatedData[user.studentNumber].totalPoints += user.totalPoints || 0;
            });

            return Object.values(aggregatedData);
        }

        function updateTable(data) {
            data.sort((a, b) => b.bottleCount - a.bottleCount);
            const dataTableBody = document.querySelector('#userTable tbody');
            dataTableBody.innerHTML = '';
            data.forEach((user, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${user.studentNumber}</td>
                    <td>${user.name}</td>
                    <td>${user.bottleCount || 0}</td>
                `;
                dataTableBody.appendChild(row);
            });
        }

        function openModal() {
            document.getElementById('userModal').style.display = 'block';
            document.getElementById('bottle-info-section').style.display = 'block'; 
            startScanBottleButton.classList.add('disabled-button'); 
            startScanBottleButton.disabled = true; 
            confirmScanBottleButton.style.display = 'none'; 
        }

        function closeModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        let currentUserId = null;

        async function displayUserInfo(id) {
            try {
                console.log('Fetching user info for user ID:', id); 
                const data = await window.electronAPI.getData();
                console.log('Fetched data:', data); 
                const user = data.find(user => user.id === id);
                console.log('Found user:', user); 
                if (user) {
                    currentUserId = user.id; 
                    document.getElementById('userName').textContent = user.name;
                    document.getElementById('userStudentNumber').textContent = user.studentNumber;
                    document.getElementById('userAvatar').src = user.avatar || 'assets/images/default-profile.png';
                    startScanBottleButton.classList.remove('disabled-button'); 
                    startScanBottleButton.disabled = false; 
                    confirmScanBottleButton.style.display = 'inline-block'; 

                    startScanUserButton.disabled = true;
                } else {
                    console.error('No such user!');
                }
            } catch (error) {
                console.error('Error fetching user info:', error);
            }
        }

        let bottleCounter = 1; 
        let totalPoints = 0; 

        async function addBottleInfo(barcode_number) {
            try {
                const data = await window.electronAPI.getPetBottles();
                const bottle = data.find(bottle => bottle.barcode_number === barcode_number);
                if (bottle) {
                    const bottleTableBody = document.querySelector('#bottleTable tbody');
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${bottleCounter++}</td> <!-- Sequential numbering -->
                        <td>${bottle.brand_name}</td>
                        <td>${bottle.size} ${bottle.size_unit}</td>
                        <td>${bottle.points}</td>
                    `;
                    bottleTableBody.appendChild(row);

                    totalPoints += Number(bottle.points); 
                    document.getElementById('totalPoints').textContent = totalPoints; 
                } else {
                    console.error('No such bottle!');
                }
            } catch (error) {
                console.error('Error fetching bottle info:', error);
            }
        }

        async function storeUserPoints() {
            const userName = document.getElementById('userName').textContent;
            const userStudentNumber = document.getElementById('userStudentNumber').textContent;
            const userAvatar = document.getElementById('userAvatar').src;
            const totalPoints = document.getElementById('totalPoints').textContent;
            const bottleCount = bottleCounter - 1; 

            const timestamp = new Date().toLocaleString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });

            try {
                await window.electronAPI.storeUserPoints({
                    id: currentUserId, 
                    name: userName,
                    studentNumber: userStudentNumber,
                    avatar: userAvatar,
                    totalPoints: Number(totalPoints), 
                    bottleCount: bottleCount, 
                    timestamp: timestamp 
                });
                alert('Data stored successfully!');
                resetModal(); 
            } catch (error) {
                console.error('Error storing data:', error);
                alert('Error storing data.');
            }
        }

        function resetModal() {
            document.getElementById('userName').textContent = '';
            document.getElementById('userStudentNumber').textContent = '';
            document.getElementById('userAvatar').src = 'assets/images/default-profile.png';

            const bottleTableBody = document.querySelector('#bottleTable tbody');
            bottleTableBody.innerHTML = ''; 
            document.getElementById('totalPoints').textContent = '0'; 
            startScanBottleButton.disabled = true; 
            confirmScanBottleButton.style.display = 'none'; 

            bottleCounter = 1;
            totalPoints = 0; 

            startScanUserButton.disabled = false; 
        }

        let barcodeInput = '';
        document.addEventListener('keydown', async (event) => {
            if (isScanningUser || isScanningBottle) {
                if (event.key === 'Enter') {
                    console.log('Barcode scanned:', barcodeInput); 
                    if (isScanningUser) {
                        await displayUserInfo(barcodeInput);
                        isScanningUser = false;
                    } else if (isScanningBottle) {
                        await addBottleInfo(barcodeInput);
                    }
                    barcodeInput = ''; 
                } else {
                    barcodeInput += event.key; 
                }
            }
        });

        const startScanUserButton = document.getElementById('start-scan-user');
        const startScanBottleButton = document.getElementById('start-scan-bottle');
        const confirmScanBottleButton = document.getElementById('confirm-scan-bottle');

        startScanUserButton.addEventListener('click', () => {
            isScanningUser = true;
            alert('Scanner connected. Ready to scan user QR code.');
        });

        startScanBottleButton.addEventListener('click', () => {
            isScanningBottle = true;
            alert('Scanner connected. Ready to scan bottle barcode.');
        });

        confirmScanBottleButton.addEventListener('click', async () => {
            isScanningBottle = false;
            await storeUserPoints(); 
        });

        // Initialize the dashboard on load
        showContent('dashboard');
    </script>
</body>

</html>