<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link id="dynamic-css" rel="stylesheet" href="assets/style.css"> <!-- Default CSS -->
    <script src="https://kit.fontawesome.com/3980f875bb.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body onload="showContent('dashboard')">
    <div class="container">
        <div class="sidebar" id="sidebar">
            <h2>Bottle Points</h2>
            <a href="#" onclick="showContent('dashboard')" id="dashboard-link"><i
                    class="fa-solid fa-chart-line"></i>&nbsp;&nbsp;&nbsp;Dashboard</a>
            <a href="#" onclick="showContent('manage-user')" id="manage-user-link"><i
                    class="fa-solid fa-users-line"></i>&nbsp;&nbsp;&nbsp;Manage User</a>
            <a href="#" onclick="showContent('leaderboard')" id="leaderboard-link"><i
                    class="fa-solid fa-ranking-star"></i>&nbsp;&nbsp;&nbsp;Leader Board</a>
            <a href="#" onclick="showContent('points-allocation')" id="points-allocation-link"><i
                    class="fa-solid fa-coins"></i>&nbsp;&nbsp;&nbsp;Points Allocation</a>
            <a href="#" onclick="showContent('redemption-reward')" id="redemption-reward-link"><i
                    class="fa-solid fa-gift"></i>&nbsp;&nbsp;&nbsp;Redemption Rewards</a>
            <a href="#" onclick="showContent('pet-bottles')" id="pet-bottles-link"><i
                    class="fa-solid fa-bottle-water"></i>&nbsp;&nbsp;&nbsp;PET Bottles</a>
            <a href="#" onclick="showContent('manage-rewards')" id="manage-rewards-link"><i
                    class="fa-solid fa-gift"></i>&nbsp;&nbsp;&nbsp;Manage
                Rewards</a>
            <a href="#" onclick="showContent('sales')"><i
                    class="fa-solid fa-bottle-water"></i>&nbsp;&nbsp;&nbsp;Sales</a>
            <a href="#" onclick="showContent('settings')"><i class="fa-solid fa-gear"></i>&nbsp;&nbsp;&nbsp;Settings</a>
            <a href="index.html"><i class="fa-solid fa-right-from-bracket"></i>&nbsp;&nbsp;&nbsp;Logout</a>
        </div>

        <div class="content" id="content">
            <link id="dynamic-css" rel="stylesheet" href="">
            <!-- Content will be displayed here -->
        </div>
    </div>

    <script>
        async function showContent(section, userId = null) {
            const content = document.getElementById('content');
            const dynamicCss = document.getElementById('dynamic-css');
            const sidebarLinks = document.querySelectorAll('.sidebar a');

            // Remove active class from all sidebar links
            sidebarLinks.forEach(link => link.classList.remove('active'));

            switch (section) {
                case 'dashboard':
                    dynamicCss.href = 'assets/style.css';
                    document.getElementById('dashboard-link').classList.add('active');
                    content.innerHTML = `
                <div class="grid-container">
                    <div class="grid-item box1" id="user-count-container">
                        <div class="user-count-text" id="user-count-text">Total Users:</div>
                        <div class="user-count-number" id="user-count">Loading...</div>
                    </div>
                    <div class="grid-item box2" id="claimed-rewards-container">
                        <div class="claimed-rewards-text" id="claimed-rewards-text">Total Claimed Rewards:</div>
                        <div class="claimed-rewards-number" id="claimed-rewards-count">Loading...</div>
                    </div>
                    <div class="grid-item box3" id="bottle-contribution-container">
                        <div class="bottle-contribution-text" id="bottle-count-text">Total Bottle Contribution:</div>
                        <div class="bottle-contribution-number" id="bottle-count">Loading...</div>
                    </div>
                    <div class="grid-item full">
                        <table id="userTable">
                            <thead>
                                <tr>
                                    <th>Rank Number</th>
                                    <th>Student Number</th>
                                    <th>Full Name</th>
                                    <th>Bottle Contribution</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                    <div class="grid-item wide">
                        <button onclick="openModal()">Start Scan</button>
                        <div class="progress-container">
                            <p id="progress-description">Bottle Disposal Progress</p>
                            <div class="progress-circle" id="progress-circle">
                                <span id="progress-text">0%</span>
                            </div>
                            <p id="progress-descriptions">Total Weight: 0g / 20000g</p>
                            
                        </div>
                    </div>
                </div>
                <div id="userModal" class="modal">
                    <div class="modal-content">
                        <span class="close" onclick="closeModal()">&times;</span>
                        <div class="modal-body">
                            <div class="modal-section user-info">
                                <h2>User Information</h2>
                                <img id="userAvatar" src="assets/images/default-profile.png" alt="User Avatar" class="avatar">
                                <div class="user-details">
                                    <p>Name:</p>
                                    <p id="userName"></p>
                                    <p>Student Number:</p>
                                    <p id="userStudentNumber"></p>
                                </div>
                                <button id="start-scan-user" class="styled-button">Scan QR</button>
                            </div>
                            <div class="modal-section bottle-info-section" id="bottle-info-section">
                                <h3>Bottle Information</h3>
                                <div class="bottle-table-container">
                                    <table id="bottleTable">
                                        <thead>
                                            <tr>
                                                <th>No.</th>
                                                <th>Brand Name</th>
                                                <th>Size</th>
                                                <th>Points</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="3" style="text-align:right;"><strong>Total Points:</strong></td>
                                                <td id="totalPoints">0</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <div class="button-container">
                                    <button id="start-scan-bottle" class="styled-button disabled-button" disabled>Scan Bottle</button>
                                    <button id="confirm-scan-bottle" class="styled-button" style="display: none;">Confirm</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
                    displayUserCount();
                    displayClaimedRewardsCount();
                    displayBottleCount();
                    fetchData();
                    updateProgressBar(); // Call the function to update the progress bar
                    break;
                case 'manage-user':
                    dynamicCss.href = 'assets/style.css';
                    document.getElementById('manage-user-link').classList.add('active');
                    content.innerHTML = `
                <div class="main-content">
                    <h2>Manage Users</h2>
                    <div class="search-bar">
                        <input type="text" id="search-input" placeholder="Search by full name or student number">
                    </div>
                    <table id="data-table">
                        <thead>
                            <tr>
                                <th>Student Number</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                    <button id="get-data">Get Data</button> 
                </div>`;
                    initializeManageUser();
                    break;
                // Add other cases here
                case 'leaderboard':
                    dynamicCss.href = 'assets/style.css';
                    document.getElementById('leaderboard-link').classList.add('active');
                    content.innerHTML = `
                    <div class="main-content">
                        <h2>Leaderboard</h2>
                        <table id="userTable">
                            <thead>
                                <tr>
                                    <th>Rank Number</th>
                                    <th>Full Name</th>
                                    <th>Collected Points
                                        <div class="filter-options">
                                            <label for="leaderboard-filter">View by:</label>
                                            <select id="leaderboard-filter">
                                                <option value="week">This Week</option>
                                                <option value="month">This Month</option>
                                                <option value="year">This Year</option>
                                            </select>
                                        </div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                        <button id="get-data" style="display:none;">Fetch Data</button>
                    </div>`;
                    initializeLeaderboard();
                    break;
                case 'points-allocation':
                    dynamicCss.href = 'assets/style.css';
                    document.getElementById('points-allocation-link').classList.add('active');
                    content.innerHTML = `
                    <div class="main-content">
                        <h2>Points Allocation</h2>
                        <div class="search-bar">
                            <input type="text" id="search-input" placeholder="Search by student number">
                        </div>
                        <table id="userTable">
                            <thead>
                                <tr>
                                    <th>Student Number</th>
                                    <th>Full Name</th>
                                    <th>Bottle Count</th>
                                    <th>Total Points</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>`;
                    initializePointsAllocation();
                    break;
                case 'redemption-reward':
                    dynamicCss.href = 'assets/style.css';
                    document.getElementById('redemption-reward-link').classList.add('active');
                    content.innerHTML = `
                    <div class="main-content">
                        <h2>Redemption Rewards</h2>
                        <div id="status" class="status-message"></div>
                        <button class="Reward" onclick="showContent('add-reward')">Add New Reward</button>
                        <div id="rewards-container" class="rewards-grid">
                            <!-- Rewards will be dynamically displayed here -->
                        </div>
                        <button id="fetch-rewards-btn" class="styled-button">Refresh Rewards</button>
                        <!-- Modal for editing reward -->
                        <div id="editModal" class="modal">
                            <div class="modal-content">
                                <span class="close" id="closeEditModal">&times;</span>
                                <h3>Edit Reward</h3>
                                <div class="edit-modal-body">
                                    <div class="image-section">
                                        <img id="editImage" class="reward-image" alt="Reward Image">
                                    </div>
                                    <div class="form-section">
                                        <label for="editName">Reward Name:</label>
                                        <input type="text" id="editName" class="modal-input">
                                        <label for="editStock">Stock:</label>
                                        <input type="number" id="editStock" class="modal-input">
                                        <label for="editPoints">Required Points:</label>
                                        <input type="number" id="editPoints" class="modal-input">
                                        <button id="saveEdit" class="modal-save-button">Save Changes</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                    initializeRedemptionReward();
                    break;
                case 'pet-bottles':
                    dynamicCss.href = 'assets/style.css';
                    document.getElementById('pet-bottles-link').classList.add('active');
                    content.innerHTML = `
                    <div class="main-content">
                        <h2>PET Bottles</h2>
                        <div id="status"></div>
                        <button class="AddBottle" onclick="showContent('add-pet-bottle')">Add New Pet Bottle</button>
                        <div id="bottles-container" class="bottles-grid">
                            <!-- Bottles will be dynamically displayed here -->
                        </div>
                        <button id="fetch-bottles-btn">Refresh Bottles</button>
                        <!-- Modal for editing bottle -->
                        <div id="editModal" class="modal">
                            <div class="modal-content">
                                <span class="close" id="closeEditModal">&times;</span>
                                <h3>Edit Bottle</h3>
                                <div class="edit-modal-body">
                                    <div class="image-section">
                                        <img id="editImage" class="bottle-image" alt="Bottle Image">
                                    </div>
                                    <div class="form-section">
                                        <label for="editBrand">Brand Name:</label>
                                        <input type="text" id="editBrand" class="modal-input">
                                        <label for="editsize">Size:</label>
                                        <div class="editsizeinput">
                                            <input type="number" id="editsize" class="modal-input" placeholder="Enter size">
                                            <select id="editsizeunit">
                                                <option value="ml">ml</option>
                                                <option value="L">L</option>
                                                <option value="oz">oz</option>
                                            </select>
                                        </div>
                                        <label for="editweight">Weight:</label>
                                        <div class="editweightinput">
                                            <input type="number" id="editweight" class="modal-input" placeholder="Enter weight">
                                            <select id="editweightunit">
                                                <option value="g">g</option>
                                                <option value="kg">kg</option>
                                                <option value="lbs">lbs</option>
                                            </select>
                                        </div>
                                        <label for="editBarcode">Barcode:</label>
                                        <input type="number" id="editBarcode" class="modal-input">
                                        <label for="editPoints">Points:</label>
                                        <input type="number" id="editPoints" class="modal-input" placeholder="Enter points">
                                        <button id="saveEdit" class="modal-save-button">Save Changes</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                    initializePetBottles();
                    break;

                case 'manage-rewards':
                    dynamicCss.href = 'assets/style.css';
                    document.getElementById('manage-rewards-link').classList.add('active');
                    content.innerHTML = `
                    <div class="main-content">
                        <h2>Manage Claimed Rewards</h2>
                        <div class="search-bar">
                            <input type="text" id="search-input" placeholder="Search by reward name or barcode">
                            <button id="start-scan">Start Scanning</button>
                        </div>
                        <div class="scanner-status" id="scanner-status">Scanner not connected</div>
                        <h3>To Be Claimed Rewards</h3>
                        <div class="table-container">
                            <table id="to-be-claimed-table">
                                <thead>
                                    <tr>
                                        <th>User Name</th>
                                        <th>Student Number</th>
                                        <th>Barcode</th>
                                        <th>Reward Name</th>
                                        <th>Points</th>
                                        <th>Claimed At</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <h3>Claimed Rewards</h3>
                        <div class="table-container">
                            <table id="claimed-table">
                                <thead>
                                    <tr>
                                        <th>User Name</th>
                                        <th>Student Number</th>
                                        <th>Barcode</th>
                                        <th>Reward Name</th>
                                        <th>Points</th>
                                        <th>Claimed At</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <button id="get-data">Get Data</button>
                    </div>`;
                    initializeClaimedRewards();
                    break;

                case 'sales':
                    dynamicCss.href = 'assets/sales.css';
                    content.innerHTML = '<h1>Sales</h1>';
                    break;
                case 'settings':
                    dynamicCss.href = 'assets/settings.css';
                    content.innerHTML = '<h1>Settings</h1>';
                    break;

                case 'edit-user':
                    dynamicCss.href = 'assets/edituser.css';
                    content.innerHTML = `
                        <div class="main-content">
                            <a href="#" class="back-to-dashboard" onclick="showContent('manage-user')">
                                <i class="fa-solid fa-arrow-left"></i>
                            </a>
                            <h2>Edit User</h2>
                            <form id="edit-user-form">
                                <label for="studentNumber">Student Number:</label>
                                <input type="text" id="studentNumber" name="studentNumber">
                                <label for="name">Full Name:</label>
                                <input type="text" id="name" name="name">
                                <label for="email">Email:</label>
                                <input type="email" id="email" name="email">
                                <button type="submit">Update User</button>
                            </form>
                        </div>`;
                    initializeEditUser(userId);
                    break;

                case 'add-reward':
                    dynamicCss.href = 'assets/addreward.css';
                    content.innerHTML = `
                    <div class="main-content">
                        <a href="#" class="back-to-dashboard" onclick="showContent('redemption-reward')">
                            <i class="fa-solid fa-arrow-left"></i>
                        </a>

                        <h2>Add New Reward</h2>
                        <form id="addRewardForm" enctype="multipart/form-data">
                            <label for="reward_name">Reward Name:</label>
                            <input type="text" id="reward_name" name="reward_name" required>

                            <label for="stock">Stock:</label>
                            <input type="number" id="stock" name="stock" required>

                            <label for="points">Required Points:</label>
                            <input type="number" id="points" name="points" required>

                            <label for="image">Reward Image:</label>
                            <input type="file" id="image" name="image" accept="image/*" required>

                            <button type="submit">Add Reward</button>
                        </form>
                    </div>`;
                    initializeAddReward();
                    break;

                case 'add-pet-bottle':
                    dynamicCss.href = 'assets/addpetbottles.css';
                    content.innerHTML = `
                    <div class="main-content">
                        <a href="#" class="back-to-dashboard" onclick="showContent('pet-bottles')">
                            <i class="fa-solid fa-arrow-left"></i>
                        </a>

                        <h2>Add New Pet Bottle</h2>
                        <form id="addBottleForm" enctype="multipart/form-data">
                            <label for="brandname">Brand Name:</label>
                            <input type="text" id="brandname" name="brandname" required>

                            <label for="bottleSize">Size:</label>
                            <input type="number" id="bottleSize" required placeholder="Enter size">
                            <select id="bottleSizeUnit" name="bottleSizeUnit" required>
                                <option value="ml">ml</option>
                                <option value="L">L</option>
                                <option value="oz">oz</option>
                            </select>

                            <label for="bottleWeight">Weight:</label>
                            <input type="number" id="bottleWeight" required placeholder="Enter weight">
                            <select id="bottleWeightUnit" name="bottleWeightUnit" required>
                                <option value="g">g</option>
                                <option value="kg">kg</option>
                                <option value="lbs">lbs</option>
                            </select>

                            <label for="barcodenumber">Barcode Number:</label>
                            <input type="number" id="barcodenumber" name="barcodenumber" required>

                            <label for="points">Points:</label>
                            <input type="number" id="points" name="points" required placeholder="Enter points">

                            <label for="image">Bottle Image:</label>
                            <input type="file" id="image" name="image" accept="image/*" required>

                            <button type="submit">Add Bottle</button>
                        </form>
                    </div>`;
                    initializeAddPetBottle();
                    break;

                default:
                    content.innerHTML = '';
            }
        }

        // FUNCTION FOR DASHBOARD
        async function displayUserCount() {
            try {
                const userCount = await window.electronAPI.getUserCount();
                document.getElementById('user-count-text').textContent = 'Total Users:';
                document.getElementById('user-count').textContent = userCount;
            } catch (error) {
                console.error('Error fetching user count:', error);
                document.getElementById('user-count-text').textContent = 'Total Users:';
                document.getElementById('user-count').textContent = 'Error loading user count';
            }
        }

        async function displayClaimedRewardsCount() {
            try {
                const claimedCount = await window.electronAPI.getClaimedRewardsCount();
                document.getElementById('claimed-rewards-text').textContent = 'Total Claimed Rewards:';
                document.getElementById('claimed-rewards-count').textContent = claimedCount;
            } catch (error) {
                console.error('Error fetching claimed rewards count:', error);
                document.getElementById('claimed-rewards-text').textContent = 'Total Claimed Rewards:';
                document.getElementById('claimed-rewards-count').textContent = 'Error loading claimed rewards count';
            }
        }

        async function displayBottleCount() {
            try {
                const bottleCount = await window.electronAPI.getTotalBottleCount();
                document.getElementById('bottle-count-text').textContent = 'Total Bottle Count:';
                document.getElementById('bottle-count').textContent = bottleCount;
            } catch (error) {
                console.error('Error fetching bottle count:', error);
                document.getElementById('bottle-count-text').textContent = 'Total Bottle Count:';
                document.getElementById('bottle-count').textContent = 'Error loading bottle count';
            }
        }

        async function updateProgressBar() {
            try {
                // Fetch total accumulated weight from all userPoints documents
                const totalWeight = await window.electronAPI.getTotalBottleWeight();

                // Set target weight (20kg = 20000g)
                const targetWeight = 20000;

                // Calculate progress percentage
                const progress = Math.min((totalWeight / targetWeight) * 100, 100);

                // Update progress circle and text
                const progressCircle = document.getElementById('progress-circle');
                const progressText = document.getElementById('progress-text');
                const progressDescription = document.getElementById('progress-descriptions');

                // Animate the progress
                let start = 0;
                const end = Math.round(progress);
                const duration = 1000;
                const stepTime = Math.abs(Math.floor(duration / end));
                let current = start;
                const increment = end > start ? 1 : -1;

                // Update progress description to show actual weight
                progressDescription.textContent = `Weight Collected: ${totalWeight.toFixed(2)}g / ${targetWeight}g`;

                const timer = setInterval(() => {
                    current += increment;
                    progressCircle.style.setProperty('--progress', `${current}%`);
                    progressText.textContent = `${current}%`;

                    if (current === end) {
                        clearInterval(timer);
                    }
                }, stepTime);
            } catch (error) {
                console.error('Error updating progress bar:', error);
                const progressText = document.getElementById('progress-text');
                progressText.textContent = 'Error';
            }
        }

        async function fetchData() {
            try {
                const data = await window.electronAPI.getUserPoints();
                console.log('Data received in renderer:', data);
                const aggregatedData = aggregateData(data);
                updateTable(aggregatedData);
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        function aggregateData(data) {
            const aggregatedData = {};

            data.forEach(user => {
                if (!aggregatedData[user.studentNumber]) {
                    aggregatedData[user.studentNumber] = {
                        studentNumber: user.studentNumber,
                        name: user.name,
                        bottleCount: 0,
                        totalPoints: 0
                    };
                }
                aggregatedData[user.studentNumber].bottleCount += user.bottleCount || 0;
                aggregatedData[user.studentNumber].totalPoints += user.totalPoints || 0;
            });

            return Object.values(aggregatedData);
        }

        function updateTable(data) {
            data.sort((a, b) => b.bottleCount - a.bottleCount);
            const dataTableBody = document.querySelector('#userTable tbody');
            dataTableBody.innerHTML = '';
            data.forEach((user, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${user.studentNumber}</td>
                    <td>${user.name}</td>
                    <td>${user.bottleCount || 0}</td>
                `;
                dataTableBody.appendChild(row);
            });
        }

        function openModal() {
            const modal = document.getElementById('userModal');
            modal.style.display = 'block';
            initializeScanningFunctionality();
        }

        function closeModal() {
            const modal = document.getElementById('userModal');
            modal.style.display = 'none';
            // Reset scanning state
            document.getElementById('start-scan-user').disabled = false;
            document.getElementById('userName').textContent = '';
            document.getElementById('userStudentNumber').textContent = '';
            document.getElementById('userAvatar').src = 'assets/images/default-profile.png';
        }

        let currentUserId = null;

        async function displayUserInfo(id) {
            try {
                console.log('Fetching user info for user ID:', id);
                const data = await window.electronAPI.getData();
                console.log('Fetched data:', data);
                const user = data.find(user => user.id === id);
                console.log('Found user:', user);
                if (user) {
                    currentUserId = user.id;
                    document.getElementById('userName').textContent = user.name;
                    document.getElementById('userStudentNumber').textContent = user.studentNumber;
                    document.getElementById('userAvatar').src = user.avatar || 'assets/images/default-profile.png';

                    // Enable bottle scanning
                    const startScanBottleButton = document.getElementById('start-scan-bottle');
                    startScanBottleButton.classList.remove('disabled-button');
                    startScanBottleButton.disabled = false;

                    // Disable user scanning
                    document.getElementById('start-scan-user').disabled = true;
                    isScanningUser = false;
                } else {
                    console.error('No such user!');
                    alert('User not found');
                }
            } catch (error) {
                console.error('Error fetching user info:', error);
                alert('Error fetching user information');
            }
        }

        let bottleCounter = 1;
        let totalPoints = 0;
        let totalWeight = 0;

        async function addBottleInfo(barcode_number) {
            try {
                console.log('Processing bottle scan:', barcode_number);
                const bottles = await window.electronAPI.getPetBottles();
                const bottle = bottles.find(b => b.barcode_number === barcode_number);

                if (bottle) {
                    // Add bottle info to table
                    const bottleTableBody = document.querySelector('#bottleTable tbody');
                    const rowCount = bottleTableBody.children.length + 1;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                <td>${rowCount}</td>
                <td>${bottle.brand_name}</td>
                <td>${bottle.size} ${bottle.size_unit}</td>
                <td>${bottle.points}</td>
            `;
                    bottleTableBody.appendChild(row);

                    // Update total points
                    const currentTotal = parseInt(document.getElementById('totalPoints').textContent) || 0;
                    const newTotal = currentTotal + parseInt(bottle.points);
                    document.getElementById('totalPoints').textContent = newTotal;

                    // Show loading alert
                    showBottleWaitingAlert();

                    // Enable scanning states
                    bottleScanned = true;
                    isScanningBottle = false;
                } else {
                    Swal.fire({
                        title: 'Error',
                        text: 'No bottle found with this barcode',
                        icon: 'error'
                    });
                }
            } catch (error) {
                console.error('Error processing bottle scan:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Error processing bottle scan',
                    icon: 'error'
                });
            }
        }

        // Add this function to show the waiting alert
        function showBottleWaitingAlert() {
            Swal.fire({
                title: 'Waiting for bottle...',
                text: 'Please place the bottle in the bin',
                icon: 'info',
                allowOutsideClick: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
        }

        // Update the bottle detection handler
        window.electronAPI.onBottleDetected((_event) => {
            // Check if modal is open and we're in bottle scanning mode
            const modal = document.getElementById('userModal');
            if (modal.style.display !== 'block' || !bottleScanned) {
                console.log('Modal is closed or not in bottle scanning mode, ignoring detection');
                return;
            }

            console.log('Bottle detected event received');
            bottleDetected = true;

            // Close the loading alert
            Swal.close();

            // Show auto-closing success message
            Swal.fire({
                title: 'Success!',
                text: 'Bottle detected! You can now scan another bottle or confirm.',
                icon: 'success',
                timer: 2000, // Will automatically close after 2 seconds
                showConfirmButton: false, // Removes the OK button
                timerProgressBar: true // Shows a progress bar
            }).then(() => {
                // Enable the confirm button
                const confirmButton = document.getElementById('confirm-scan-bottle');
                confirmButton.style.display = 'inline-block';

                // Reset scanning state for next bottle
                isScanningBottle = false;
                bottleScanned = false;

                // Enable scan bottle button for next scan
                const scanBottleButton = document.getElementById('start-scan-bottle');
                scanBottleButton.disabled = false;
            });
        });

        // Update the start bottle scan button handler
        document.getElementById('start-scan-bottle').addEventListener('click', () => {
            if (!document.getElementById('userName').textContent) {
                Swal.fire({
                    title: 'Error',
                    text: 'Please scan user QR code first',
                    icon: 'error'
                });
                return;
            }

            console.log('Starting bottle scan');
            isScanningUser = false;
            isScanningBottle = true;
            bottleScanned = false;
            barcodeInput = '';

            Swal.fire({
                title: 'Ready',
                text: 'Please scan the bottle barcode',
                icon: 'info',
                timer: 2000,
                showConfirmButton: false
            });
        });

        // Update the confirm button handler
        document.getElementById('confirm-scan-bottle').addEventListener('click', async () => {
            if (!bottleDetected) {
                Swal.fire({
                    title: 'Error',
                    text: 'Please place the bottle in the bin first',
                    icon: 'error'
                });
                return;
            }

            try {
                await storeUserPoints();
                resetModalState();

                Swal.fire({
                    title: 'Success!',
                    text: 'Points stored successfully',
                    icon: 'success'
                });
            } catch (error) {
                console.error('Error storing points:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to store points',
                    icon: 'error'
                });
            }
        });

        async function storeUserPoints() {
            try {
                // Get all bottles from the table
                const bottleTableBody = document.querySelector('#bottleTable tbody');
                const rows = bottleTableBody.getElementsByTagName('tr');
                let totalWeight = 0;
                let totalPoints = parseInt(document.getElementById('totalPoints').textContent) || 0;

                // Calculate total weight from all scanned bottles
                for (let row of rows) {
                    const brandName = row.cells[1].textContent; // Get brand name from table
                    try {
                        // Fetch bottle details from Firebase
                        const bottles = await window.electronAPI.getPetBottles();
                        const bottle = bottles.find(b => b.brand_name === brandName);
                        if (bottle) {
                            // Convert weight to number and add to total
                            const weight = parseFloat(bottle.weight) || 0;
                            totalWeight += weight;
                        }
                    } catch (error) {
                        console.error('Error fetching bottle details:', error);
                    }
                }

                const userPointData = {
                    id: currentUserId,
                    name: document.getElementById('userName').textContent,
                    studentNumber: document.getElementById('userStudentNumber').textContent,
                    avatar: document.getElementById('userAvatar').src,
                    totalPoints: totalPoints,
                    bottleCount: bottleTableBody.children.length,
                    totalWeight: totalWeight, // Add the total weight
                    timestamp: new Date().toLocaleString('en-US', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    })
                };

                const result = await window.electronAPI.storeUserPoints(userPointData);

                if (result.success) {
                    // Reset states and UI
                    bottleScanned = false;
                    bottleDetected = false;

                    // Clear the table
                    bottleTableBody.innerHTML = '';
                    document.getElementById('totalPoints').textContent = '0';

                    // Hide confirm button and reset scan button
                    document.getElementById('confirm-scan-bottle').style.display = 'none';
                    document.getElementById('start-scan-bottle').disabled = false;

                    // Show success message
                    await Swal.fire({
                        title: 'Success!',
                        text: 'Points and weight recorded successfully. Please check your account to verify. Thanks for your contribution!',
                        icon: 'success'
                    });

                    // Reset modal
                    resetModal();
                } else {
                    throw new Error('Failed to store points');
                }
            } catch (error) {
                console.error('Error storing points:', error);
                await Swal.fire({
                    title: 'Error',
                    text: 'Failed to store points',
                    icon: 'error'
                });
            }
        }

        // Update the resetModal function
        function resetModal() {
            // Reset user info
            document.getElementById('userName').textContent = '';
            document.getElementById('userStudentNumber').textContent = '';
            document.getElementById('userAvatar').src = 'assets/images/default-profile.png';

            // Reset bottle table
            const bottleTableBody = document.querySelector('#bottleTable tbody');
            bottleTableBody.innerHTML = '';
            document.getElementById('totalPoints').textContent = '0';

            // Reset buttons
            const startScanBottleButton = document.getElementById('start-scan-bottle');
            const confirmScanBottleButton = document.getElementById('confirm-scan-bottle');
            startScanBottleButton.disabled = true;
            confirmScanBottleButton.style.display = 'none';

            // Reset states
            bottleCounter = 1;
            totalPoints = 0;
            bottleScanned = false;
            bottleDetected = false;
            currentUserId = null;

            // Enable user scanning
            document.getElementById('start-scan-user').disabled = false;
        }


        function initializeScanningFunctionality() {
            // Get fresh references to buttons
            const startScanUserButton = document.getElementById('start-scan-user');
            const startScanBottleButton = document.getElementById('start-scan-bottle');
            const confirmScanBottleButton = document.getElementById('confirm-scan-bottle');

            // Remove existing event listeners
            const newStartScanUserButton = startScanUserButton.cloneNode(true);
            const newStartScanBottleButton = startScanBottleButton.cloneNode(true);
            const newConfirmScanBottleButton = confirmScanBottleButton.cloneNode(true);

            startScanUserButton.parentNode.replaceChild(newStartScanUserButton, startScanUserButton);
            startScanBottleButton.parentNode.replaceChild(newStartScanBottleButton, startScanBottleButton);
            confirmScanBottleButton.parentNode.replaceChild(newConfirmScanBottleButton, confirmScanBottleButton);

            // Add keydown event listener for scanning
            document.addEventListener('keydown', async (event) => {
                if (isScanningUser || isScanningBottle) {
                    if (event.key === 'Enter') {
                        console.log('Scanned barcode:', barcodeInput);
                        if (isScanningUser) {
                            await displayUserInfo(barcodeInput);
                        } else if (isScanningBottle) {
                            await addBottleInfo(barcodeInput);
                        }
                        barcodeInput = '';
                    } else {
                        barcodeInput += event.key;
                    }
                }
            });

            // Start user scanning
            newStartScanUserButton.addEventListener('click', () => {
                console.log('Starting user scan');
                isScanningUser = true;
                isScanningBottle = false;
                barcodeInput = '';
                alert('Ready to scan user QR code');
            });

            // Start bottle scanning
            newStartScanBottleButton.addEventListener('click', () => {
                console.log('Starting bottle scan');
                if (!document.getElementById('userName').textContent) {
                    alert('Please scan user QR code first');
                    return;
                }
                isScanningUser = false;
                isScanningBottle = true;
                barcodeInput = '';
                alert('Ready to scan bottle barcode');
            });

            // Confirm bottle scan
            newConfirmScanBottleButton.addEventListener('click', async () => {
                if (bottleDetected) {
                    await storeUserPoints();
                    bottleScanned = false;
                    bottleDetected = false;
                    newConfirmScanBottleButton.style.display = 'none';
                    newStartScanBottleButton.disabled = false;
                } else {
                    alert('Please place the bottle in the bin to proceed.');
                }
            });
        }

        // startScanUserButton.addEventListener('click', () => {
        //     isScanningUser = true;
        //     alert('Scanner connected. Ready to scan user QR code.');
        // });



        // Initialize the dashboard on load

        // FUNCTION FOR MANAGE USER

        function initializeManageUser() {
            const getDataButton = document.getElementById('get-data');
            const dataTableBody = document.querySelector('#data-table tbody');
            const searchInput = document.getElementById('search-input');

            // Fetch and display data in the table
            async function fetchData() {
                try {
                    const data = await window.electronAPI.getData();
                    console.log('Data received in renderer:', data);
                    updateTable(data); // Update table with fetched data
                } catch (error) {
                    console.error('Error fetching data:', error);
                }
            }

            // Update table with user data
            function updateTable(data) {
                // Clear previous table rows
                dataTableBody.innerHTML = '';
                data.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.studentNumber}</td>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>
                            <button class="edit-user" data-id="${user.id}">Edit</button>
                            <button class="delete-user" data-id="${user.id}">Delete</button>
                        </td>
                    `;
                    dataTableBody.appendChild(row);
                });
                attachEventHandlers(); // Reattach event handlers for both edit and delete
            }

            // Fetch and display data on button click (or on page load)
            getDataButton.addEventListener('click', fetchData);

            // Search functionality
            searchInput.addEventListener('input', async () => {
                const query = searchInput.value.toLowerCase();
                const data = await window.electronAPI.getData(); // Fetch all data
                const filteredData = data.filter(user => {
                    return user.name.toLowerCase().includes(query) || user.studentNumber.toString().includes(query);
                });
                updateTable(filteredData); // Update table with filtered data
            });

            // Attach event handlers to edit and delete buttons
            function attachEventHandlers() {
                // Handle Edit button
                document.querySelectorAll('.edit-user').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const userId = event.target.getAttribute('data-id');
                        showContent('edit-user', userId);
                    });
                });

                // Handle Delete button
                document.querySelectorAll('.delete-user').forEach(button => {
                    button.addEventListener('click', async (event) => {
                        const userId = event.target.getAttribute('data-id');
                        try {
                            await window.electronAPI.deleteUser(userId);
                            alert('User deleted successfully');
                            const row = event.target.closest('tr');
                            row.remove(); // Immediately remove the row from the UI
                        } catch (error) {
                            console.error('Error deleting user:', error);
                        }
                    });
                });
            }

            // Auto-fetch data when page loads
            getDataButton.click();
        }

        //FUNCTION FOR LEADERBOARD
        function initializeManageUser() {
            const getDataButton = document.getElementById('get-data');
            const dataTableBody = document.querySelector('#data-table tbody');
            const searchInput = document.getElementById('search-input');

            // Fetch and display data in the table
            async function fetchData() {
                try {
                    const data = await window.electronAPI.getData();
                    console.log('Data received in renderer:', data);
                    updateTable(data); // Update table with fetched data
                } catch (error) {
                    console.error('Error fetching data:', error);
                }
            }

            // Update table with user data
            function updateTable(data) {
                // Clear previous table rows
                dataTableBody.innerHTML = '';
                data.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${user.studentNumber}</td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>
                        <button class="edit-user" data-id="${user.id}">Edit</button>
                        <button class="delete-user" data-id="${user.id}">Delete</button>
                    </td>
                `;
                    dataTableBody.appendChild(row);
                });
                attachEventHandlers(); // Reattach event handlers for both edit and delete
            }

            // Fetch and display data on button click (or on page load)
            getDataButton.addEventListener('click', fetchData);

            // Search functionality
            searchInput.addEventListener('input', async () => {
                const query = searchInput.value.toLowerCase();
                const data = await window.electronAPI.getData(); // Fetch all data
                const filteredData = data.filter(user => {
                    return user.name.toLowerCase().includes(query) || user.studentNumber.toString().includes(query);
                });
                updateTable(filteredData); // Update table with filtered data
            });

            // Attach event handlers to edit and delete buttons
            function attachEventHandlers() {
                // Handle Edit button
                document.querySelectorAll('.edit-user').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const userId = event.target.getAttribute('data-id');
                        showContent('edit-user', userId);
                    });
                });

                // Handle Delete button
                document.querySelectorAll('.delete-user').forEach(button => {
                    button.addEventListener('click', async (event) => {
                        const userId = event.target.getAttribute('data-id');
                        try {
                            await window.electronAPI.deleteUser(userId);
                            alert('User deleted successfully');
                            const row = event.target.closest('tr');
                            row.remove(); // Immediately remove the row from the UI
                        } catch (error) {
                            console.error('Error deleting user:', error);
                        }
                    });
                });
            }

            // Auto-fetch data when page loads
            getDataButton.click();
        }

        function initializeLeaderboard() {
            const dataTableBody = document.querySelector('#userTable tbody');

            // Fetch and display data in the table
            async function fetchData() {
                try {
                    const data = await window.electronAPI.getUserPoints();
                    console.log('Data received in renderer:', data);
                    const aggregatedData = aggregateData(data);
                    updateTable(aggregatedData); // Update table with aggregated data
                } catch (error) {
                    console.error('Error fetching data:', error);
                }
            }

            // Aggregate data by name
            function aggregateData(data) {
                const aggregatedData = {};

                data.forEach(user => {
                    if (!aggregatedData[user.name]) {
                        aggregatedData[user.name] = {
                            name: user.name,
                            bottleCount: 0,
                            totalPoints: 0
                        };
                    }
                    aggregatedData[user.name].bottleCount += user.bottleCount || 0;
                    aggregatedData[user.name].totalPoints += user.totalPoints || 0;
                });

                return Object.values(aggregatedData);
            }

            // Update table with user data
            function updateTable(data) {
                // Sort data by total points in descending order
                data.sort((a, b) => b.totalPoints - a.totalPoints);

                dataTableBody.innerHTML = '';
                data.forEach((user, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${user.name}</td>
                        <td>${user.totalPoints || 0}</td>
                    `;
                    dataTableBody.appendChild(row);
                });
            }

            // Auto-fetch data when page loads
            fetchData();
        }

        //FUNCTION FOR POINTS ALLOCATION
        function initializePointsAllocation() {
            const dataTableBody = document.querySelector('#userTable tbody');
            const searchInput = document.getElementById('search-input');

            // Fetch and display data in the table
            async function fetchData() {
                try {
                    const data = await window.electronAPI.getUserPoints();
                    console.log('Data received in renderer:', data);
                    const aggregatedData = aggregateData(data);
                    updateTable(aggregatedData); // Update table with aggregated data
                } catch (error) {
                    console.error('Error fetching data:', error);
                }
            }

            // Aggregate data by student number
            function aggregateData(data) {
                const aggregatedData = {};

                data.forEach(user => {
                    if (!aggregatedData[user.studentNumber]) {
                        aggregatedData[user.studentNumber] = {
                            studentNumber: user.studentNumber,
                            name: user.name,
                            bottleCount: 0,
                            totalPoints: 0
                        };
                    }
                    aggregatedData[user.studentNumber].bottleCount += user.bottleCount || 0;
                    aggregatedData[user.studentNumber].totalPoints += user.totalPoints || 0;
                });

                return Object.values(aggregatedData);
            }

            // Update table with user data
            function updateTable(data) {
                // Sort data by total points in descending order
                data.sort((a, b) => b.totalPoints - a.totalPoints);
                // Clear previous table rows
                dataTableBody.innerHTML = '';
                data.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${user.studentNumber}</td>
                    <td>${user.name}</td>
                    <td>${user.bottleCount}</td>
                    <td>${user.totalPoints}</td>
                `;
                    dataTableBody.appendChild(row);
                });
            }

            // Search functionality
            searchInput.addEventListener('input', async () => {
                const query = searchInput.value.toLowerCase();
                const data = await window.electronAPI.getUserPoints(); // Fetch all data
                const aggregatedData = aggregateData(data);
                const filteredData = aggregatedData.filter(user => {
                    return user.studentNumber.toString().includes(query); // Filter by student number
                });
                updateTable(filteredData); // Update table with filtered data
            });

            // Auto-fetch data when page loads
            fetchData();
        }

        //FUNCTION FOR REDEMPTION REWARDS

        function initializeRedemptionReward() {
            const rewardsContainer = document.getElementById('rewards-container');
            const statusDiv = document.getElementById('status');
            const editModal = document.getElementById('editModal');
            const closeEditModal = document.getElementById('closeEditModal');
            const editImage = document.getElementById('editImage');
            const editName = document.getElementById('editName');
            const editStock = document.getElementById('editStock');
            const editPoints = document.getElementById('editPoints');
            const saveEdit = document.getElementById('saveEdit');

            // Function to fetch and display rewards
            async function fetchRewards() {
                try {
                    const rewards = await window.electronAPI.getRewards(); // Get rewards from Firebase via Electron API
                    console.log('Rewards received:', rewards);
                    // Clear previous content
                    rewardsContainer.innerHTML = '';

                    // Loop through the rewards and display each one
                    rewards.forEach(reward => {
                        const rewardElement = document.createElement('div');
                        rewardElement.classList.add('reward-item');

                        // Display reward image, name, stock, and action buttons
                        rewardElement.innerHTML = `
                        <div class="reward-image">
                            <img src="${reward.image_url}" alt="${reward.reward_name}" />
                        </div>
                        <div class="reward-details">
                            <h3>${reward.reward_name}</h3>
                            <p>Stock: ${reward.stock}</p>
                            <p>Points: ${reward.points}</p>
                            <button class="edit-button" onclick="openEditModal('${reward.id}', '${reward.reward_name}', ${reward.stock}, ${reward.points}, '${reward.image_url}')">Edit</button>
                            <button class="delete-button" onclick="deleteReward('${reward.id}')">Delete</button>
                        </div>
                    `;

                        rewardsContainer.appendChild(rewardElement);
                    });
                } catch (error) {
                    console.error('Error fetching rewards:', error);
                    statusDiv.innerText = 'Failed to fetch rewards.';
                }
            }

            // Function to open the edit modal
            window.openEditModal = function (id, name, stock, points, imageUrl) {
                editImage.src = imageUrl;
                editName.value = name;
                editStock.value = stock;
                editPoints.value = points;
                editModal.style.display = 'block';

                saveEdit.onclick = async function () {
                    try {
                        await window.electronAPI.updateReward(id, {
                            reward_name: editName.value,
                            stock: editStock.value,
                            points: editPoints.value,
                            image_url: imageUrl
                        });
                        alert('Reward updated successfully');
                        editModal.style.display = 'none';
                        fetchRewards(); // Refresh the rewards list
                    } catch (error) {
                        console.error('Error updating reward:', error);
                        alert('Failed to update reward.');
                    }
                };
            };

            // Function to delete a reward
            window.deleteReward = async function (id) {
                try {
                    await window.electronAPI.deleteReward(id);
                    alert('Reward deleted successfully');
                    fetchRewards(); // Refresh the rewards list
                } catch (error) {
                    console.error('Error deleting reward:', error);
                    alert('Failed to delete reward.');
                }
            };

            // Close the edit modal
            closeEditModal.onclick = function () {
                editModal.style.display = 'none';
            };

            // Fetch rewards on initialization
            fetchRewards();

            // Refresh rewards on button click
            document.getElementById('fetch-rewards-btn').onclick = fetchRewards;
        }

        //FUNCTION FOR PET BOTTLES
        function initializePetBottles() {
            const bottlesContainer = document.getElementById('bottles-container');
            const statusDiv = document.getElementById('status');
            const editModal = document.getElementById('editModal');
            const closeEditModal = document.getElementById('closeEditModal');
            const editImage = document.getElementById('editImage');
            const editBrand = document.getElementById('editBrand');
            const editSize = document.getElementById('editsize');
            const editSizeUnit = document.getElementById('editsizeunit');
            const editWeight = document.getElementById('editweight');
            const editWeightUnit = document.getElementById('editweightunit');
            const editBarcode = document.getElementById('editBarcode');
            const editPoints = document.getElementById('editPoints');
            const saveEdit = document.getElementById('saveEdit');

            // Function to fetch and display bottles
            async function fetchBottles() {
                try {
                    const bottles = await window.electronAPI.getPetBottles();
                    console.log('Bottles received in renderer:', bottles);
                    bottlesContainer.innerHTML = ''; // Clear previous content

                    // Loop through the bottles and display each one
                    bottles.forEach(bottle => {
                        const bottleElement = document.createElement('div');
                        bottleElement.classList.add('bottle-item');

                        // Display bottle image, brand name, size, weight, barcode number, and points
                        bottleElement.innerHTML = `
                        <div class="bottle-image">
                            <img src="${bottle.image_url}" alt="${bottle.brand_name}" />
                        </div>
                        <div class="bottle-details">
                            <h3>${bottle.brand_name}</h3>
                            <p>Size: ${bottle.size} ${bottle.size_unit}</p>
                            <p>Weight: ${bottle.weight} ${bottle.weight_unit}</p>
                            <p>Barcode: ${bottle.barcode_number}</p>
                            <p>Points: ${bottle.points}</p>
                            <button class="edit-button" onclick="editBottle('${bottle.id}', '${bottle.brand_name}', ${bottle.size}, '${bottle.size_unit}', ${bottle.weight}, '${bottle.weight_unit}', '${bottle.barcode_number}', '${bottle.image_url}', ${bottle.points})">Edit</button>
                            <button class="delete-button" onclick="deleteBottle('${bottle.id}')">Delete</button>
                        </div>
                    `;

                        bottlesContainer.appendChild(bottleElement);
                    });
                } catch (error) {
                    console.error('Error fetching bottles:', error);
                    statusDiv.innerText = 'Failed to fetch bottles';
                }
            }

            // Open edit modal
            window.editBottle = function (id, brand_name, size, size_unit, weight, weight_unit, barcode, imageUrl, points) {
                editBrand.value = brand_name;
                editSize.value = size;
                editSizeUnit.value = size_unit;
                editWeight.value = weight;
                editWeightUnit.value = weight_unit;
                editBarcode.value = barcode;
                editPoints.value = points;
                editImage.src = imageUrl;
                editModal.style.display = 'block';

                // Link saveEdit function to the save button
                saveEdit.onclick = () => saveEditBottle(id);
            };

            // Save edited bottle
            async function saveEditBottle(id) {
                const brand_name = editBrand.value;
                const size = editSize.value;
                const size_unit = editSizeUnit.value;
                const weight = editWeight.value;
                const weight_unit = editWeightUnit.value;
                const barcode = editBarcode.value;
                const points = editPoints.value;

                try {
                    await window.electronAPI.editPetBottle(id, brand_name, size, size_unit, weight, weight_unit, barcode, points);
                    editModal.style.display = 'none'; // Close modal
                    fetchBottles(); // Refresh the bottles list to reflect the updated data
                } catch (error) {
                    console.error('Error saving bottle:', error);
                    statusDiv.innerText = 'Failed to save bottle';
                }
            }

            // Delete bottle
            window.deleteBottle = async function (id) {
                const confirmDelete = confirm("Are you sure you want to delete this bottle?");
                if (confirmDelete) {
                    try {
                        await window.electronAPI.deletePetBottle(id); // Delete bottle via Electron API
                        fetchBottles(); // Refresh the bottles list after deletion
                    } catch (error) {
                        console.error('Error deleting bottle:', error);
                        statusDiv.innerText = 'Failed to delete bottle';
                    }
                }
            };

            // Event listener for the fetch bottles button
            document.getElementById('fetch-bottles-btn').addEventListener('click', fetchBottles);

            // Event listener for the close button
            closeEditModal.addEventListener('click', () => {
                editModal.style.display = 'none';
            });

            // Fetch bottles on initialization
            fetchBottles();
        }

        //FUNCTION FOR MANAGE CLAIMED REWARDS
        function initializeClaimedRewards() {
            const getDataButton = document.getElementById('get-data');
            const toBeClaimedTableBody = document.querySelector('#to-be-claimed-table tbody');
            const claimedTableBody = document.querySelector('#claimed-table tbody');
            const searchInput = document.getElementById('search-input');
            const scannerStatus = document.getElementById('scanner-status');
            const startScanButton = document.getElementById('start-scan');
            let claimedRewardsData = [];
            let isScanning = false;

            // Fetch and display data in the tables
            async function fetchData() {
                try {
                    const data = await window.electronAPI.getClaimedRewards();
                    claimedRewardsData = data; // Store the data for later use
                    displayTables(data); // Update both tables with fetched data
                } catch (error) {
                    console.error('Error fetching data:', error);
                }
            }

            // Display data in both "to be claimed" and "claimed" tables
            function displayTables(data) {
                // Filter and sort data for each table
                const toBeClaimedRewards = data
                    .filter(reward => reward.status === 'toBeClaimed')
                    .sort((a, b) => new Date(b.claimedAt) - new Date(a.claimedAt));
                console.log('To Be Claimed Rewards:', toBeClaimedRewards);  // Debugging: View "To Be Claimed" rewards

                const claimedRewards = data
                    .filter(reward => reward.status === 'claimed')
                    .sort((a, b) => new Date(b.claimedAt) - new Date(a.claimedAt));
                console.log('Claimed Rewards:', claimedRewards);  // Debugging: View "Claimed" rewards

                // Update tables with sorted data
                updateTable(toBeClaimedTableBody, toBeClaimedRewards, "To Be Claimed Rewards");
                updateTable(claimedTableBody, claimedRewards, "Claimed Rewards");
            }

            // Update table with reward data
            function updateTable(tableBody, data, status) {
                tableBody.innerHTML = ''; // Clear previous table rows
                if (data.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="8">No ${status.toLowerCase()} available</td>`;
                    tableBody.appendChild(row);
                    return;
                }
                data.forEach(reward => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${reward.userName}</td>
                    <td>${reward.studentNumber}</td>
                    <td>${reward.barcode}</td>
                    <td>${reward.name}</td>
                    <td>${reward.points}</td>
                    <td>${new Date(reward.claimedAt).toLocaleString()}</td>
                    <td>${reward.status}</td>
                    <td>
                        <button class="delete-reward" data-id="${reward.id}">Delete</button>
                    </td>
                `;
                    tableBody.appendChild(row);
                });
                attachEventHandlers(); // Attach event handlers for each table's buttons
            }

            // Fetch and display data on button click
            getDataButton.addEventListener('click', fetchData);

            // Attach event handlers to delete buttons
            function attachEventHandlers() {
                document.querySelectorAll('.delete-reward').forEach(button => {
                    button.addEventListener('click', async (event) => {
                        const rewardId = event.target.getAttribute('data-id');
                        try {
                            await window.electronAPI.deleteClaimedReward(rewardId);
                            alert('Reward deleted successfully');
                            fetchData(); // Refresh data after deletion
                        } catch (error) {
                            console.error('Error deleting reward:', error);
                        }
                    });
                });
            }

            // Search functionality
            searchInput.addEventListener('input', () => {
                const query = searchInput.value.toLowerCase();
                const filteredData = claimedRewardsData.filter(reward => {
                    return reward.name.toLowerCase().includes(query) || reward.barcode.toString().includes(query);
                });
                displayTables(filteredData); // Display only matching results in both tables
            });

            // Barcode scanning functionality
            let barcodeInput = '';
            document.addEventListener('keydown', async (event) => {
                if (isScanning) {
                    if (event.key === 'Enter') {
                        handleBarcodeScan(barcodeInput);
                        barcodeInput = ''; // Reset input
                    } else {
                        barcodeInput += event.key;
                    }
                }
            });

            async function handleBarcodeScan(barcode) {
                const reward = claimedRewardsData.find(reward => reward.barcode === barcode);
                if (reward) {
                    try {
                        const currentTime = new Date().toISOString();
                        await window.electronAPI.updateClaimedRewardStatus(reward.id, 'claimed', currentTime);
                        alert(`Reward with barcode ${barcode} marked as claimed.`);
                        fetchData(); // Refresh tables
                    } catch (error) {
                        console.error('Error updating reward status:', error);
                    }
                } else {
                    alert(`No reward found with barcode ${barcode}.`);
                }
            }

            // Start scanning
            startScanButton.addEventListener('click', () => {
                isScanning = true;
                scannerStatus.textContent = 'Scanner connected. Ready to scan.';
                scannerStatus.style.color = 'green';
            });

            // Fetch rewards on initialization
            fetchData();
        }


        //FUNCTION FOR EDIT USER
        function initializeEditUser(userId) {
            // Fetch user data and populate the form
            (async () => {
                if (userId) {
                    try {
                        const userData = await window.electronAPI.getData();  // Call the correct function
                        const user = userData.find(user => user.id === userId);  // Match the user by ID

                        if (user) {
                            document.getElementById('studentNumber').value = user.studentNumber;
                            document.getElementById('name').value = user.name;
                            document.getElementById('email').value = user.email;
                        } else {
                            console.error('User not found.');
                        }
                    } catch (error) {
                        console.error('Error fetching user data:', error);
                    }
                }
            })();

            const form = document.getElementById('edit-user-form');
            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                const updatedData = {
                    studentNumber: document.getElementById('studentNumber').value,
                    name: document.getElementById('name').value,
                    email: document.getElementById('email').value,
                };

                try {
                    await window.electronAPI.editUser(userId, updatedData.studentNumber, updatedData.name, updatedData.email);
                    alert('User updated successfully');
                    showContent('manage-user');
                } catch (error) {
                    console.error('Error updating user:', error);
                }
            });
        }

        //FUNCTION FOR ADD REWARD
        function initializeAddReward() {
            const addRewardForm = document.getElementById('addRewardForm');

            const handleFormSubmit = async (event) => {
                event.preventDefault();

                const rewardName = document.getElementById('reward_name').value;
                const rewardStock = document.getElementById('stock').value;
                const rewardPoints = document.getElementById('points').value;
                const rewardImage = document.getElementById('image').files[0];

                if (!rewardImage) {
                    alert('Please select an image');
                    return;
                }

                try {
                    // Read the file content
                    const reader = new FileReader();
                    reader.onload = async function (event) {
                        const fileContent = event.target.result;

                        // Upload image to Firebase Storage
                        const { success: uploadSuccess, imageUrl, error: uploadError } = await window.electronAPI.uploadImage({ fileContent, fileName: rewardImage.name });
                        if (!uploadSuccess) {
                            throw new Error(uploadError);
                        }

                        // Save reward details to Firestore
                        const reward = {
                            reward_name: rewardName,
                            stock: rewardStock,
                            points: rewardPoints,
                            image_url: imageUrl
                        };

                        const { success: addSuccess, error: addError } = await window.electronAPI.addReward(reward);
                        if (!addSuccess) {
                            throw new Error(addError);
                        }

                        alert('Reward added successfully');
                        addRewardForm.reset();
                        showContent('redemption-reward');
                    };
                    reader.readAsArrayBuffer(rewardImage);
                } catch (error) {
                    console.error('Error adding reward:', error);
                    alert('Failed to add reward');
                }
            };

            addRewardForm.addEventListener('submit', handleFormSubmit);

            // Ensure the form is reset when navigating back to this page
            window.addEventListener('pageshow', () => {
                addRewardForm.reset();
            });
        }

        //FUNCTION FOR ADD PET BOTTLE
        function initializeAddPetBottle() {
            const addBottleForm = document.getElementById('addBottleForm');

            const handleFormSubmit = async (event) => {
                event.preventDefault();

                const brandName = document.getElementById('brandname').value;
                const bottleSize = document.getElementById('bottleSize').value;
                const bottleSizeUnit = document.getElementById('bottleSizeUnit').value;
                const bottleWeight = document.getElementById('bottleWeight').value;
                const bottleWeightUnit = document.getElementById('bottleWeightUnit').value;
                const barcodeNumber = document.getElementById('barcodenumber').value;
                const points = document.getElementById('points').value;
                const bottleImage = document.getElementById('image').files[0];

                if (!bottleImage) {
                    alert('Please select an image');
                    return;
                }

                try {
                    // Read the file content
                    const reader = new FileReader();
                    reader.onload = async function (event) {
                        const fileContent = event.target.result;

                        // Upload image to Firebase Storage
                        const { success: uploadSuccess, imageUrl, error: uploadError } = await window.electronAPI.uploadPetBottleImage({ fileContent, fileName: bottleImage.name });
                        if (!uploadSuccess) {
                            throw new Error(uploadError);
                        }

                        // Save pet bottle details to Firestore
                        const petBottle = {
                            brand_name: brandName,
                            size: bottleSize,
                            size_unit: bottleSizeUnit,
                            weight: bottleWeight,
                            weight_unit: bottleWeightUnit,
                            barcode_number: barcodeNumber,
                            points: points,
                            image_url: imageUrl
                        };

                        const { success: addSuccess, error: addError } = await window.electronAPI.addPetBottle(petBottle);
                        if (!addSuccess) {
                            throw new Error(addError);
                        }

                        alert('Pet bottle added successfully');
                        addBottleForm.reset();
                        showContent('pet-bottles');
                    };
                    reader.readAsArrayBuffer(bottleImage);
                } catch (error) {
                    console.error('Error adding pet bottle:', error);
                    alert('Failed to add pet bottle');
                }
            };

            addBottleForm.addEventListener('submit', handleFormSubmit);

            // Ensure the form is reset when navigating back to this page
            window.addEventListener('pageshow', () => {
                addBottleForm.reset();
            });
        }

        // Initialize the dashboard on load
        showContent('dashboard');

        async function fetchDashboardData() {
            try {
                const userCount = await window.electronAPI.getUserCount();
                const claimedRewards = await window.electronAPI.getClaimedRewardsCount();
                const bottleContributions = await window.electronAPI.getBottleContributions();

                document.getElementById('user-count').innerText = userCount.total;
                document.getElementById('user-change').innerText = userCount.change > 0 ? ` ${userCount.change}%` : ` ${Math.abs(userCount.change)}%`;
                document.getElementById('user-change').classList.toggle('positive', userCount.change > 0);
                document.getElementById('user-change').classList.toggle('negative', userCount.change < 0);

                document.getElementById('claimed-rewards-count').innerText = claimedRewards.total;
                document.getElementById('rewards-change').innerText = claimedRewards.change > 0 ? ` ${claimedRewards.change}%` : ` ${Math.abs(claimedRewards.change)}%`;
                document.getElementById('rewards-change').classList.toggle('positive', claimedRewards.change > 0);
                document.getElementById('rewards-change').classList.toggle('negative', claimedRewards.change < 0);

                document.getElementById('bottle-count').innerText = bottleContributions.total;
                document.getElementById('bottle-change').innerText = bottleContributions.change > 0 ? ` ${bottleContributions.change}%` : ` ${Math.abs(bottleContributions.change)}%`;
                document.getElementById('bottle-change').classList.toggle('positive', bottleContributions.change > 0);
                document.getElementById('bottle-change').classList.toggle('negative', bottleContributions.change < 0);
            } catch (error) {
                console.error('Error fetching dashboard data:', error);
            }
        }

        // Call this function when the dashboard is loaded
        fetchDashboardData();
    </script>
</body>

</html>