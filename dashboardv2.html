<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link id="dynamic-css" rel="stylesheet" href="assets/style.css"> <!-- Default CSS -->
    <script src="https://kit.fontawesome.com/3980f875bb.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .can-claim {
            color: green;
            font-weight: bold;
        }
        
        .pending {
            color: orange;
            font-weight: bold;
        }
    </style>
</head>

<body onload="showContent('dashboard')">
    <div class="container">
        <div class="sidebar" id="sidebar">
            <h2>Bottle Points</h2>
            <a href="#" onclick="showContent('dashboard')" id="dashboard-link"><i
                    class="fa-solid fa-chart-line"></i>&nbsp;&nbsp;&nbsp;Dashboard</a>
            <a href="#" onclick="showContent('manage-user')" id="manage-user-link"><i
                    class="fa-solid fa-users-line"></i>&nbsp;&nbsp;&nbsp;Manage User</a>
            <a href="#" onclick="showContent('leaderboard')" id="leaderboard-link"><i
                    class="fa-solid fa-ranking-star"></i>&nbsp;&nbsp;&nbsp;Leader Board</a>
            <a href="#" onclick="showContent('points-allocation')" id="points-allocation-link"><i
                    class="fa-solid fa-coins"></i>&nbsp;&nbsp;&nbsp;Points Allocation</a>
            <a href="#" onclick="showContent('redemption-reward')" id="redemption-reward-link"><i
                    class="fa-solid fa-gift"></i>&nbsp;&nbsp;&nbsp;Redemption Rewards</a>
            <a href="#" onclick="showContent('pet-bottles')" id="pet-bottles-link"><i
                    class="fa-solid fa-bottle-water"></i>&nbsp;&nbsp;&nbsp;PET Bottles</a>
            <a href="#" onclick="showContent('manage-rewards')" id="manage-rewards-link"><i
                    class="fa-solid fa-gift"></i>&nbsp;&nbsp;&nbsp;Manage
                Rewards</a>
            <a href="#" onclick="showContent('sales')"><i
                    class="fa-solid fa-bottle-water"></i>&nbsp;&nbsp;&nbsp;Sales</a>
            <a href="#" onclick="showContent('reports')" id="reports-link">
                <i class="fa-solid fa-flag"></i>&nbsp;&nbsp;&nbsp;Reports
            </a>
            <a href="#" onclick="showContent('settings')"><i class="fa-solid fa-gear"></i>&nbsp;&nbsp;&nbsp;Settings</a>
            <a href="index.html"><i class="fa-solid fa-right-from-bracket"></i>&nbsp;&nbsp;&nbsp;Logout</a>
        </div>

        <div class="content" id="content">
            <link id="dynamic-css" rel="stylesheet" href="">
            <!-- Content will be displayed here -->
        </div>
    </div>

    <script>
        async function showContent(section, userId = null) {
            const content = document.getElementById('content');
            const dynamicCss = document.getElementById('dynamic-css');
            const sidebarLinks = document.querySelectorAll('.sidebar a');

            // Always use the main stylesheet
            dynamicCss.href = 'assets/style.css';

            // Remove active class from all sidebar links
            sidebarLinks.forEach(link => link.classList.remove('active'));

            // Add active class to the clicked link
            const activeLink = document.getElementById(`${section}-link`);
            if (activeLink) {
                activeLink.classList.add('active');
            }

            switch (section) {
                case 'dashboard':
                    dynamicCss.href = 'assets/style.css';
                    document.getElementById('dashboard-link').classList.add('active');
                    content.innerHTML = `
                <div class="analytics-container">
                    <!-- Revenue Chart Section -->
                    <div class="chart-card revenue-chart-container">
                        <h3>Revenue Over Time</h3>
                        <div class="chart-header">
                            <div class="chart-legend">
                                <span class="legend-item">
                                    <span class="dot revenue-dot"></span>
                                    Total Revenue
                                </span>
                                <span class="legend-item">
                                    <span class="dot target-dot"></span>
                                    Target Revenue
                                </span>
                            </div>
                            <select id="revenue-timeframe">
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="year">This Year</option>
                            </select>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>

                    <!-- Statistics Grid -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-coins"></i>
                            </div>
                            <div class="stat-info">
                                <h4>Total Revenue</h4>
                                <p class="stat-value" id="total-revenue">â‚±0.00</p>
                                <p class="stat-change positive">+5.5% from last month</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-bottle-water"></i>
                            </div>
                            <div class="stat-info">
                                <h4>Total Bottles</h4>
                                <p class="stat-value" id="total-bottles">0</p>
                                <p class="stat-change positive">+3.2% from last month</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-scale-balanced"></i>
                            </div>
                            <div class="stat-info">
                                <h4>Total Weight</h4>
                                <p class="stat-value" id="total-weight">0g</p>
                                <p class="stat-change positive">+4.1% from last month</p>
                            </div>
                        </div>
                    </div>

                    <!-- Distribution Charts -->
                    <div class="charts-grid">
                        <div class="chart-card">
                            <h3>Bottle Collection by Day</h3>
                            <div class="chart-wrapper">
                                <canvas id="bottleDistributionChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h3>Top Contributors</h3>
                            <div class="chart-wrapper">
                                <canvas id="contributorsChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Progress Section -->
                    <div class="progress-section">
                        <div class="progress-card">
                            <h3>Bottle Collection Progress</h3>
                            <div class="progress-container">
                                <div class="progress-circle" id="progress-circle">
                                    <span id="progress-text">0%</span>
                                </div>
                                <p id="progress-description">Total Weight: 0g / 20000g</p>
                            </div>
                        </div>
                    </div>
                </div>`;

                    // Add styles with fixed dimensions
                    const dashboardStyles = document.createElement('style');
                    dashboardStyles.textContent = `
                        .analytics-container {
                            padding: 20px;
                            gap: 20px;
                            max-width: 100%;
                            overflow-x: hidden;
                        }

                        .chart-card {
                            background: white;
                            border-radius: 12px;
                            padding: 20px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            margin-bottom: 20px;
                        }

                        .revenue-chart-container {
                            height: 500px; /* Fixed container height */
                        }

                        .chart-wrapper {
                            position: relative;
                            height: 350px; /* Fixed chart height */
                            width: 100%;
                        }

                        .chart-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 15px;
                            height: 40px; /* Fixed header height */
                        }

                        .chart-legend {
                            display: flex;
                            gap: 15px;
                        }

                        .legend-item {
                            display: flex;
                            align-items: center;
                            gap: 5px;
                        }

                        .dot {
                            width: 10px;
                            height: 10px;
                            border-radius: 50%;
                        }

                        .revenue-dot {
                            background-color: #7a9b57;
                        }

                        .target-dot {
                            background-color: #ffa726;
                        }

                        .stats-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                            gap: 20px;
                            margin-bottom: 20px;
                        }

                        .stat-card {
                            background: white;
                            border-radius: 12px;
                            padding: 20px;
                            display: flex;
                            align-items: center;
                            gap: 15px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        }

                        .stat-icon {
                            width: 50px;
                            height: 50px;
                            border-radius: 10px;
                            background: #7a9b57;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 1.5em;
                        }

                        .stat-info h4 {
                            margin: 0;
                            color: #666;
                        }

                        .stat-value {
                            font-size: 1.5em;
                            font-weight: bold;
                            margin: 5px 0;
                        }

                        .stat-change {
                            font-size: 0.9em;
                            margin: 0;
                        }

                        .stat-change.positive {
                            color: #4caf50;
                        }

                        .charts-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
                            gap: 20px;
                            margin-bottom: 20px;
                        }

                        .progress-section {
                            display: grid;
                            grid-template-columns: 1fr;
                            gap: 20px;
                        }

                        .progress-card {
                            background: white;
                            border-radius: 12px;
                            padding: 20px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        }
                    `;
                    document.head.appendChild(dashboardStyles);

                    // Initialize charts with fixed dimensions
                    initializeDashboardCharts();
                    break;
                case 'manage-user':
                    dynamicCss.href = 'assets/style.css';
                    document.getElementById('manage-user-link').classList.add('active');
                    content.innerHTML = `
                <div class="main-content">
                    <h2>Manage Users</h2>
                    <div class="search-bar">
                        <input type="text" id="search-input" placeholder="Search by full name or student number">
                    </div>
                    <table id="data-table">
                        <thead>
                            <tr>
                                <th>Student Number</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                    <button id="get-data">Get Data</button> 
                </div>`;
                    initializeManageUser();
                    break;
                // Add other cases here
                case 'leaderboard':
                    dynamicCss.href = 'assets/style.css';
                    document.getElementById('leaderboard-link').classList.add('active');
                    content.innerHTML = `
                    <div class="main-content">
                        <h2>Leaderboard</h2>
                        <table id="userTable">
                            <thead>
                                <tr>
                                    <th>Rank Number</th>
                                    <th>Full Name</th>
                                    <th>Collected Points
                                        <div class="filter-options">
                                            <label for="leaderboard-filter">View by:</label>
                                            <select id="leaderboard-filter">
                                                <option value="week">This Week</option>
                                                <option value="month">This Month</option>
                                                <option value="year">This Year</option>
                                            </select>
                                        </div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                        <button id="get-data" style="display:none;">Fetch Data</button>
                    </div>`;
                    initializeLeaderboard();
                    break;
                case 'points-allocation':
                    dynamicCss.href = 'assets/style.css';
                    document.getElementById('points-allocation-link').classList.add('active');
                    content.innerHTML = `
                    <div class="main-content">
                        <h2>Points Allocation</h2>
                        <div class="search-bar">
                            <input type="text" id="search-input" placeholder="Search by student number">
                        </div>
                        <table id="userTable">
                            <thead>
                                <tr>
                                    <th>Student Number</th>
                                    <th>Full Name</th>
                                    <th>Bottle Count</th>
                                    <th>Total Points</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>`;
                    initializePointsAllocation();
                    break;
                case 'redemption-reward':
                    dynamicCss.href = 'assets/style.css';
                    document.getElementById('redemption-reward-link').classList.add('active');
                    content.innerHTML = `
                    <div class="main-content">
                        <h2>Redemption Rewards</h2>
                        <div id="status" class="status-message"></div>
                        <button class="Reward" onclick="showContent('add-reward')">Add New Reward</button>
                        <div id="rewards-container" class="rewards-grid">
                            <!-- Rewards will be dynamically displayed here -->
                        </div>
                        <button id="fetch-rewards-btn" class="styled-button">Refresh Rewards</button>
                        <!-- Modal for editing reward -->
                        <div id="editModal" class="modal">
                            <div class="modal-content">
                                <span class="close" id="closeEditModal">&times;</span>
                                <h3>Edit Reward</h3>
                                <div class="edit-modal-body">
                                    <div class="image-section">
                                        <img id="editImage" class="reward-image" alt="Reward Image">
                                    </div>
                                    <div class="form-section">
                                        <label for="editName">Reward Name:</label>
                                        <input type="text" id="editName" class="modal-input">
                                        <label for="editStock">Stock:</label>
                                        <input type="number" id="editStock" class="modal-input">
                                        <label for="editPoints">Required Points:</label>
                                        <input type="number" id="editPoints" class="modal-input">
                                        <button id="saveEdit" class="modal-save-button">Save Changes</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                    initializeRedemptionReward();
                    break;
                case 'pet-bottles':
                    dynamicCss.href = 'assets/style.css';
                    document.getElementById('pet-bottles-link').classList.add('active');
                    content.innerHTML = `
                    <div class="main-content">
                        <h2>PET Bottles</h2>
                        <div id="status"></div>
                        <button class="AddBottle" onclick="showContent('add-pet-bottle')">Add New Pet Bottle</button>
                        <div id="bottles-container" class="bottles-grid">
                            <!-- Bottles will be dynamically displayed here -->
                        </div>
                        <button id="fetch-bottles-btn">Refresh Bottles</button>
                        <!-- Modal for editing bottle -->
                        <div id="editModal" class="modal">
                            <div class="modal-content">
                                <span class="close" id="closeEditModal">&times;</span>
                                <h3>Edit Bottle</h3>
                                <div class="edit-modal-body">
                                    <div class="image-section">
                                        <img id="editImage" class="bottle-image" alt="Bottle Image">
                                    </div>
                                    <div class="form-section">
                                        <label for="editBrand">Brand Name:</label>
                                        <input type="text" id="editBrand" class="modal-input">
                                        <label for="editsize">Size:</label>
                                        <div class="editsizeinput">
                                            <input type="number" id="editsize" class="modal-input" placeholder="Enter size">
                                            <select id="editsizeunit">
                                                <option value="ml">ml</option>
                                                <option value="L">L</option>
                                                <option value="oz">oz</option>
                                            </select>
                                        </div>
                                        <label for="editweight">Weight:</label>
                                        <div class="editweightinput">
                                            <input type="number" id="editweight" class="modal-input" placeholder="Enter weight">
                                            <select id="editweightunit">
                                                <option value="g">g</option>
                                                <option value="kg">kg</option>
                                                <option value="lbs">lbs</option>
                                            </select>
                                        </div>
                                        <label for="editBarcode">Barcode:</label>
                                        <input type="number" id="editBarcode" class="modal-input">
                                        <label for="editPoints">Points:</label>
                                        <input type="number" id="editPoints" class="modal-input" placeholder="Enter points">
                                        <button id="saveEdit" class="modal-save-button">Save Changes</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                    initializePetBottles();
                    break;

                case 'manage-rewards':
                    dynamicCss.href = 'assets/style.css';
                    document.getElementById('manage-rewards-link').classList.add('active');
                    content.innerHTML = `
                    <div class="main-content">
                        <h2>Manage Claimed Rewards</h2>
                        <div class="search-bar">
                            <input type="text" id="search-input" placeholder="Search by reward name or barcode">
                            <button id="start-scan">Start Scanning</button>
                        </div>
                        <div class="scanner-status" id="scanner-status">Scanner not connected</div>
                        <h3>To Be Claimed Rewards</h3>
                        <div class="table-container">
                            <table id="to-be-claimed-table">
                                <thead>
                                    <tr>
                                        <th>User Name</th>
                                        <th>Student Number</th>
                                        <th>Barcode</th>
                                        <th>Reward Name</th>
                                        <th>Points</th>
                                        <th>Claimed At</th>
                                        <th>Status</th>
                                        <th>Claim Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <h3>Claimed Rewards</h3>
                        <div class="table-container">
                            <table id="claimed-table">
                                <thead>
                                    <tr>
                                        <th>User Name</th>
                                        <th>Student Number</th>
                                        <th>Barcode</th>
                                        <th>Reward Name</th>
                                        <th>Points</th>
                                        <th>Claimed At</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <button id="get-data">Get Data</button>
                    </div>`;
                    initializeClaimedRewards();
                    break;

                case 'sales':
                    dynamicCss.href = 'assets/style.css';
                    content.innerHTML = `
                        <div class="main-content">
                            <h2>Sales Analytics</h2>
                            
                            <!-- Statistics Cards -->
                            <div class="stats-container">
                                <div class="stat-card">
                                    <h3>Total Revenue</h3>
                                    <p class="stat-value" id="total-revenue">â‚±0.00</p>
                                </div>
                                <div class="stat-card">
                                    <h3>Total Bottles</h3>
                                    <p class="stat-value" id="total-bottles">0</p>
                                </div>
                                <div class="stat-card">
                                    <h3>Average Daily Sales</h3>
                                    <p class="stat-value" id="avg-daily-sales">â‚±0.00</p>
                                </div>
                            </div>

                            <!-- Filters and Search -->
                            <div class="filters-container">
                                <div class="search-bar">
                                    <input type="text" id="sales-search" placeholder="Search transactions...">
                                </div>
                                <div class="date-filters">
                                    <input type="date" id="date-from">
                                    <span>to</span>
                                    <input type="date" id="date-to">
                                </div>
                                <button class="export-btn">
                                    <i class="fas fa-file-excel"></i>
                                    Export to Excel
                                </button>
                            </div>

                            <!-- Sales Table -->
                            <div class="table-container">
                                <table id="sales-table">
                                    <thead>
                                        <tr>
                                            <th data-sort="transactionId">Transaction ID <i class="fas fa-sort"></i></th>
                                            <th data-sort="date">Date <i class="fas fa-sort"></i></th>
                                            <th data-sort="studentNumber">Student Number <i class="fas fa-sort"></i></th>
                                            <th data-sort="name">Name <i class="fas fa-sort"></i></th>
                                            <th data-sort="bottleCount">Bottles <i class="fas fa-sort"></i></th>
                                            <th data-sort="totalWeight">Weight (g) <i class="fas fa-sort"></i></th>
                                            <th data-sort="points">Points <i class="fas fa-sort"></i></th>
                                            <th data-sort="amount">Amount <i class="fas fa-sort"></i></th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>`;
                    
                    // Add CSS styles for sorting indicators
                    const styleSheet = document.createElement("style");
                    styleSheet.textContent = `
                        #sales-table th {
                            cursor: pointer;
                            position: relative;
                        }
                        #sales-table th i {
                            margin-left: 5px;
                            font-size: 0.8em;
                        }
                        #sales-table th.sorted-asc i:before {
                            content: "\\f0de"; /* Font Awesome up arrow */
                        }
                        #sales-table th.sorted-desc i:before {
                            content: "\\f0dd"; /* Font Awesome down arrow */
                        }
                        .table-container {
                            margin-top: 20px;
                            overflow-x: auto;
                            max-height: 500px;
                            overflow-y: auto;
                        }
                        #sales-table thead {
                            position: sticky;
                            top: 0;
                            z-index: 1;
                            background-color: #7a9b57;
                        }
                    `;
                    document.head.appendChild(styleSheet);
                    initializeSales();
                    break;
                case 'settings':
                    dynamicCss.href = 'assets/settings.css';
                    content.innerHTML = '<h1>Settings</h1>';
                    break;

                case 'edit-user':
                    dynamicCss.href = 'assets/edituser.css';
                    content.innerHTML = `
                        <div class="main-content">
                            <a href="#" class="back-to-dashboard" onclick="showContent('manage-user')">
                                <i class="fa-solid fa-arrow-left"></i>
                            </a>
                            <h2>Edit User</h2>
                            <form id="edit-user-form">
                                <label for="studentNumber">Student Number:</label>
                                <input type="text" id="studentNumber" name="studentNumber">
                                <label for="name">Full Name:</label>
                                <input type="text" id="name" name="name">
                                <label for="email">Email:</label>
                                <input type="email" id="email" name="email">
                                <button type="submit">Update User</button>
                            </form>
                        </div>`;
                    initializeEditUser(userId);
                    break;

                case 'add-reward':
                    dynamicCss.href = 'assets/style.css';
                    content.innerHTML = `
                    <div class="main-content">
                        <a href="#" class="back-to-dashboard" onclick="showContent('redemption-reward')">
                            <i class="fa-solid fa-arrow-left"></i>
                        </a>

                        <h2>Add New Reward</h2>
                        <form id="addRewardForm" enctype="multipart/form-data">
                            <label for="reward_name">Reward Name:</label>
                            <input type="text" id="reward_name" name="reward_name" required>

                            <label for="stock">Stock:</label>
                            <input type="number" id="stock" name="stock" required>

                            <label for="points">Required Points:</label>
                            <input type="number" id="points" name="points" required>

                            <label for="image">Reward Image:</label>
                            <input type="file" id="image" name="image" accept="image/*" required>

                            <button type="submit">Add Reward</button>
                        </form>
                    </div>`;
                    initializeAddReward();
                    break;

                case 'add-pet-bottle':
                    dynamicCss.href = 'assets/style.css';
                    content.innerHTML = `
                    <div class="main-content">
                        <a href="#" class="back-to-dashboard" onclick="showContent('pet-bottles')">
                            <i class="fa-solid fa-arrow-left"></i>
                        </a>

                        <h2>Add New Pet Bottle</h2>
                        <form id="addBottleForm" enctype="multipart/form-data">
                            <label for="brandname">Brand Name:</label>
                            <input type="text" id="brandname" name="brandname" required>

                            <label for="bottleSize">Size:</label>
                            <input type="number" id="bottleSize" required placeholder="Enter size">
                            <select id="bottleSizeUnit" name="bottleSizeUnit" required>
                                <option value="ml">ml</option>
                                <option value="L">L</option>
                                <option value="oz">oz</option>
                            </select>

                            <label for="bottleWeight">Weight:</label>
                            <input type="number" id="bottleWeight" required placeholder="Enter weight">
                            <select id="bottleWeightUnit" name="bottleWeightUnit" required>
                                <option value="g">g</option>
                                <option value="kg">kg</option>
                                <option value="lbs">lbs</option>
                            </select>

                            <label for="barcodenumber">Barcode Number:</label>
                            <input type="number" id="barcodenumber" name="barcodenumber" required>

                            <label for="points">Points:</label>
                            <input type="number" id="points" name="points" required placeholder="Enter points">

                            <label for="image">Bottle Image:</label>
                            <input type="file" id="image" name="image" accept="image/*" required>

                            <button type="submit">Add Bottle</button>
                        </form>
                    </div>`;
                    initializeAddPetBottle();
                    break;

                case 'reports':
                    content.innerHTML = `
                        <div class="reports-container">
                            <h2>User Reports Management</h2>
                            <div class="reports-filters">
                                <select id="status-filter">
                                    <option value="all">Filter by Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="in-progress">In Progress</option>
                                    <option value="resolved">Resolved</option>
                                </select>
                                <select id="category-filter">
                                    <option value="all">Filter by Category</option>
                                    <option value="performance">App Performance</option>
                                    <option value="rewards">Reward Issues</option>
                                    <option value="account">Account Problems</option>
                                    <option value="points">Points/Bottles Issues</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="reports-list" id="reports-list">
                                <!-- Reports will be dynamically added here -->
                            </div>
                        </div>
                    `;
                    initializeReports();
                    break;

                default:
                    content.innerHTML = '';
            }
        }

        // FUNCTION FOR DASHBOARD
        async function displayUserCount() {
            try {
                const userCount = await window.electronAPI.getUserCount();
                document.getElementById('user-count-text').textContent = 'Total Users:';
                document.getElementById('user-count').textContent = userCount;
            } catch (error) {
                console.error('Error fetching user count:', error);
                document.getElementById('user-count-text').textContent = 'Total Users:';
                document.getElementById('user-count').textContent = 'Error loading user count';
            }
        }

        async function displayClaimedRewardsCount() {
            try {
                const claimedCount = await window.electronAPI.getClaimedRewardsCount();
                document.getElementById('claimed-rewards-text').textContent = 'Total Claimed Rewards:';
                document.getElementById('claimed-rewards-count').textContent = claimedCount;
            } catch (error) {
                console.error('Error fetching claimed rewards count:', error);
                document.getElementById('claimed-rewards-text').textContent = 'Total Claimed Rewards:';
                document.getElementById('claimed-rewards-count').textContent = 'Error loading claimed rewards count';
            }
        }

        async function displayBottleCount() {
            try {
                const bottleCount = await window.electronAPI.getTotalBottleCount();
                document.getElementById('bottle-count-text').textContent = 'Total Bottle Count:';
                document.getElementById('bottle-count').textContent = bottleCount;
            } catch (error) {
                console.error('Error fetching bottle count:', error);
                document.getElementById('bottle-count-text').textContent = 'Total Bottle Count:';
                document.getElementById('bottle-count').textContent = 'Error loading bottle count';
            }
        }

        async function fetchData() {
            try {
                const data = await window.electronAPI.getUserPoints();
                console.log('Data received in renderer:', data);
                const aggregatedData = aggregateData(data);
                updateTable(aggregatedData);
                updateProgressCircle();
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        function aggregateData(data) {
            const aggregatedData = {};

            data.forEach(user => {
                if (!aggregatedData[user.studentNumber]) {
                    aggregatedData[user.studentNumber] = {
                        studentNumber: user.studentNumber,
                        name: user.name,
                        bottleCount: 0,
                        totalPoints: 0
                    };
                }
                aggregatedData[user.studentNumber].bottleCount += user.bottleCount || 0;
                aggregatedData[user.studentNumber].totalPoints += user.totalPoints || 0;
            });

            return Object.values(aggregatedData);
        }

        function updateTable(data) {
            data.sort((a, b) => b.bottleCount - a.bottleCount);
            const dataTableBody = document.querySelector('#userTable tbody');
            dataTableBody.innerHTML = '';
            data.forEach((user, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${user.studentNumber}</td>
                    <td>${user.name}</td>
                    <td>${user.bottleCount || 0}</td>
                `;
                dataTableBody.appendChild(row);
            });
        }

        async function updateProgressCircle() {
            try {
                const totalWeight = await window.electronAPI.getTotalBottleWeight();
                const targetWeight = 20000; // 20kg in grams
                const percentage = Math.min((totalWeight / targetWeight) * 100, 100);
                
                const circle = document.getElementById('progress-circle');
                const text = document.getElementById('progress-text');
                const description = document.getElementById('progress-descriptions');
                
                // Update the circle's background
                circle.style.background = `conic-gradient(
                    #83951c ${percentage * 3.6}deg,
                    #ecf0f1 ${percentage * 3.6}deg
                )`;
                
                // Update the percentage text
                text.textContent = `${Math.round(percentage)}%`;
                
                // Update the description text
                description.textContent = `Total Weight: ${totalWeight}g / ${targetWeight}g`;
            } catch (error) {
                console.error('Error updating progress circle:', error);
            }
        }

        // Initialize the dashboard on load
        showContent('dashboard');

        async function fetchDashboardData() {
            try {
                const userCount = await window.electronAPI.getUserCount();
                const claimedRewards = await window.electronAPI.getClaimedRewardsCount();
                const bottleContributions = await window.electronAPI.getBottleContributions();

                document.getElementById('user-count').innerText = userCount.total;
                document.getElementById('user-change').innerText = userCount.change > 0 ? `â†‘ ${userCount.change}%` : `â†“ ${Math.abs(userCount.change)}%`;
                document.getElementById('user-change').classList.toggle('positive', userCount.change > 0);
                document.getElementById('user-change').classList.toggle('negative', userCount.change < 0);

                document.getElementById('claimed-rewards-count').innerText = claimedRewards.total;
                document.getElementById('rewards-change').innerText = claimedRewards.change > 0 ? `â†‘ ${claimedRewards.change}%` : `â†“ ${Math.abs(claimedRewards.change)}%`;
                document.getElementById('rewards-change').classList.toggle('positive', claimedRewards.change > 0);
                document.getElementById('rewards-change').classList.toggle('negative', claimedRewards.change < 0);

                document.getElementById('bottle-count').innerText = bottleContributions.total;
                document.getElementById('bottle-change').innerText = bottleContributions.change > 0 ? `â†‘ ${bottleContributions.change}%` : `â†“ ${Math.abs(bottleContributions.change)}%`;
                document.getElementById('bottle-change').classList.toggle('positive', bottleContributions.change > 0);
                document.getElementById('bottle-change').classList.toggle('negative', bottleContributions.change < 0);
            } catch (error) {
                console.error('Error fetching dashboard data:', error);
            }
        }

        // Call this function when the dashboard is loaded
        fetchDashboardData();

        //FUNCTION FOR MANAGE USER
        function initializeManageUser() {
            const getDataButton = document.getElementById('get-data');
            const dataTableBody = document.querySelector('#data-table tbody');
            const searchInput = document.getElementById('search-input');

            // Fetch and display data in the table
            async function fetchData() {
                try {
                    const data = await window.electronAPI.getData();
                    console.log('Data received in renderer:', data);
                    updateTable(data); // Update table with fetched data
                } catch (error) {
                    console.error('Error fetching data:', error);
                }
            }

            // Update table with user data
            function updateTable(data) {
                // Clear previous table rows
                dataTableBody.innerHTML = '';
                data.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.studentNumber}</td>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>
                            <button class="edit-user" data-id="${user.id}">Edit</button>
                            <button class="delete-user" data-id="${user.id}">Delete</button>
                        </td>
                    `;
                    dataTableBody.appendChild(row);
                });
                attachEventHandlers(); // Reattach event handlers for both edit and delete
            }

            // Fetch and display data on button click (or on page load)
            getDataButton.addEventListener('click', fetchData);

            // Search functionality
            searchInput.addEventListener('input', async () => {
                const query = searchInput.value.toLowerCase();
                const data = await window.electronAPI.getData(); // Fetch all data
                const filteredData = data.filter(user => {
                    return user.name.toLowerCase().includes(query) || user.studentNumber.toString().includes(query);
                });
                updateTable(filteredData); // Update table with filtered data
            });

            // Attach event handlers to edit and delete buttons
            function attachEventHandlers() {
                // Handle Edit button
                document.querySelectorAll('.edit-user').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const userId = event.target.getAttribute('data-id');
                        showContent('edit-user', userId);
                    });
                });

                // Handle Delete button
                document.querySelectorAll('.delete-user').forEach(button => {
                    button.addEventListener('click', async (event) => {
                        const userId = event.target.getAttribute('data-id');
                        try {
                            await window.electronAPI.deleteUser(userId);
                            alert('User deleted successfully');
                            const row = event.target.closest('tr');
                            row.remove(); // Immediately remove the row from the UI
                        } catch (error) {
                            console.error('Error deleting user:', error);
                        }
                    });
                });
            }

            // Auto-fetch data when page loads
            getDataButton.click();
        }

        //FUNCTION FOR LEADERBOARD
        function initializeLeaderboard() {
            const dataTableBody = document.querySelector('#userTable tbody');

            // Fetch and display data in the table
            async function fetchData() {
                try {
                    const data = await window.electronAPI.getUserPoints();
                    console.log('Data received in renderer:', data);
                    const aggregatedData = aggregateData(data);
                    updateTable(aggregatedData); // Update table with aggregated data
                } catch (error) {
                    console.error('Error fetching data:', error);
                }
            }

            // Aggregate data by name
            function aggregateData(data) {
                const aggregatedData = {};

                data.forEach(user => {
                    if (!aggregatedData[user.name]) {
                        aggregatedData[user.name] = {
                            name: user.name,
                            bottleCount: 0,
                            totalPoints: 0
                        };
                    }
                    aggregatedData[user.name].bottleCount += user.bottleCount || 0;
                    aggregatedData[user.name].totalPoints += user.totalPoints || 0;
                });

                return Object.values(aggregatedData);
            }

            // Update table with user data
            function updateTable(data) {
                // Sort data by total points in descending order
                data.sort((a, b) => b.totalPoints - a.totalPoints);

                dataTableBody.innerHTML = '';
                data.forEach((user, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${user.name}</td>
                        <td>${user.totalPoints || 0}</td>
                    `;
                    dataTableBody.appendChild(row);
                });
            }

            // Auto-fetch data when page loads
            fetchData();
        }

        //FUNCTION FOR POINTS ALLOCATION
        function initializePointsAllocation() {
            const dataTableBody = document.querySelector('#userTable tbody');
            const searchInput = document.getElementById('search-input');

            // Fetch and display data in the table
            async function fetchData() {
                try {
                    const data = await window.electronAPI.getUserPoints();
                    console.log('Data received in renderer:', data);
                    const aggregatedData = aggregateData(data);
                    updateTable(aggregatedData); // Update table with aggregated data
                } catch (error) {
                    console.error('Error fetching data:', error);
                }
            }

            // Aggregate data by student number
            function aggregateData(data) {
                const aggregatedData = {};

                data.forEach(user => {
                    if (!aggregatedData[user.studentNumber]) {
                        aggregatedData[user.studentNumber] = {
                            studentNumber: user.studentNumber,
                            name: user.name,
                            bottleCount: 0,
                            totalPoints: 0
                        };
                    }
                    aggregatedData[user.studentNumber].bottleCount += user.bottleCount || 0;
                    aggregatedData[user.studentNumber].totalPoints += user.totalPoints || 0;
                });

                return Object.values(aggregatedData);
            }

            // Update table with user data
            function updateTable(data) {
                // Sort data by total points in descending order
                data.sort((a, b) => b.totalPoints - a.totalPoints);
                // Clear previous table rows
                dataTableBody.innerHTML = '';
                data.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${user.studentNumber}</td>
                    <td>${user.name}</td>
                    <td>${user.bottleCount}</td>
                    <td>${user.totalPoints}</td>
                `;
                    dataTableBody.appendChild(row);
                });
            }

            // Search functionality
            searchInput.addEventListener('input', async () => {
                const query = searchInput.value.toLowerCase();
                const data = await window.electronAPI.getUserPoints(); // Fetch all data
                const aggregatedData = aggregateData(data);
                const filteredData = aggregatedData.filter(user => {
                    return user.studentNumber.toString().includes(query); // Filter by student number
                });
                updateTable(filteredData); // Update table with filtered data
            });

            // Auto-fetch data when page loads
            fetchData();
        }

        //FUNCTION FOR REDEMPTION REWARDS

        function initializeRedemptionReward() {
            const rewardsContainer = document.getElementById('rewards-container');
            const statusDiv = document.getElementById('status');
            const editModal = document.getElementById('editModal');
            const closeEditModal = document.getElementById('closeEditModal');
            const editImage = document.getElementById('editImage');
            const editName = document.getElementById('editName');
            const editStock = document.getElementById('editStock');
            const editPoints = document.getElementById('editPoints');
            const saveEdit = document.getElementById('saveEdit');

            // Function to fetch and display rewards
            async function fetchRewards() {
                try {
                    const rewards = await window.electronAPI.getRewards(); // Get rewards from Firebase via Electron API
                    console.log('Rewards received:', rewards);
                    // Clear previous content
                    rewardsContainer.innerHTML = '';

                    // Loop through the rewards and display each one
                    rewards.forEach(reward => {
                        const rewardElement = document.createElement('div');
                        rewardElement.classList.add('reward-item');

                        // Display reward image, name, stock, and action buttons
                        rewardElement.innerHTML = `
                        <div class="reward-image">
                            <img src="${reward.image_url}" alt="${reward.reward_name}" />
                        </div>
                        <div class="reward-details">
                            <h3>${reward.reward_name}</h3>
                            <p>Stock: ${reward.stock}</p>
                            <p>Points: ${reward.points}</p>
                            <button class="edit-button" onclick="openEditModal('${reward.id}', '${reward.reward_name}', ${reward.stock}, ${reward.points}, '${reward.image_url}')">Edit</button>
                            <button class="delete-button" onclick="deleteReward('${reward.id}')">Delete</button>
                        </div>
                    `;

                        rewardsContainer.appendChild(rewardElement);
                    });
                } catch (error) {
                    console.error('Error fetching rewards:', error);
                    statusDiv.innerText = 'Failed to fetch rewards.';
                }
            }

            // Function to open the edit modal
            window.openEditModal = function (id, name, stock, points, imageUrl) {
                editImage.src = imageUrl;
                editName.value = name;
                editStock.value = stock;
                editPoints.value = points;
                editModal.style.display = 'block';

                saveEdit.onclick = async function () {
                    try {
                        await window.electronAPI.updateReward(id, {
                            reward_name: editName.value,
                            stock: editStock.value,
                            points: editPoints.value,
                            image_url: imageUrl
                        });
                        alert('Reward updated successfully');
                        editModal.style.display = 'none';
                        fetchRewards(); // Refresh the rewards list
                    } catch (error) {
                        console.error('Error updating reward:', error);
                        alert('Failed to update reward.');
                    }
                };
            };

            // Function to delete a reward
            window.deleteReward = async function (id) {
                try {
                    await window.electronAPI.deleteReward(id);
                    alert('Reward deleted successfully');
                    fetchRewards(); // Refresh the rewards list
                } catch (error) {
                    console.error('Error deleting reward:', error);
                    alert('Failed to delete reward.');
                }
            };

            // Close the edit modal
            closeEditModal.onclick = function () {
                editModal.style.display = 'none';
            };

            // Fetch rewards on initialization
            fetchRewards();

            // Refresh rewards on button click
            document.getElementById('fetch-rewards-btn').onclick = fetchRewards;
        }

        //FUNCTION FOR PET BOTTLES
        function initializePetBottles() {
            const bottlesContainer = document.getElementById('bottles-container');
            const statusDiv = document.getElementById('status');
            const editModal = document.getElementById('editModal');
            const closeEditModal = document.getElementById('closeEditModal');
            const editImage = document.getElementById('editImage');
            const editBrand = document.getElementById('editBrand');
            const editSize = document.getElementById('editsize');
            const editSizeUnit = document.getElementById('editsizeunit');
            const editWeight = document.getElementById('editweight');
            const editWeightUnit = document.getElementById('editweightunit');
            const editBarcode = document.getElementById('editBarcode');
            const editPoints = document.getElementById('editPoints');
            const saveEdit = document.getElementById('saveEdit');

            // Function to fetch and display bottles
            async function fetchBottles() {
                try {
                    const bottles = await window.electronAPI.getPetBottles();
                    console.log('Bottles received in renderer:', bottles);
                    bottlesContainer.innerHTML = ''; // Clear previous content

                    // Loop through the bottles and display each one
                    bottles.forEach(bottle => {
                        const bottleElement = document.createElement('div');
                        bottleElement.classList.add('bottle-item');

                        // Display bottle image, brand name, size, weight, barcode number, and points
                        bottleElement.innerHTML = `
                        <div class="bottle-image">
                            <img src="${bottle.image_url}" alt="${bottle.brand_name}" />
                        </div>
                        <div class="bottle-details">
                            <h3>${bottle.brand_name}</h3>
                            <p>Size: ${bottle.size} ${bottle.size_unit}</p>
                            <p>Weight: ${bottle.weight} ${bottle.weight_unit}</p>
                            <p>Barcode: ${bottle.barcode_number}</p>
                            <p>Points: ${bottle.points}</p>
                            <button class="edit-button" onclick="editBottle('${bottle.id}', '${bottle.brand_name}', ${bottle.size}, '${bottle.size_unit}', ${bottle.weight}, '${bottle.weight_unit}', '${bottle.barcode_number}', '${bottle.image_url}', ${bottle.points})">Edit</button>
                            <button class="delete-button" onclick="deleteBottle('${bottle.id}')">Delete</button>
                        </div>
                    `;

                        bottlesContainer.appendChild(bottleElement);
                    });
                } catch (error) {
                    console.error('Error fetching bottles:', error);
                    statusDiv.innerText = 'Failed to fetch bottles';
                }
            }

            // Open edit modal
            window.editBottle = function (id, brand_name, size, size_unit, weight, weight_unit, barcode, imageUrl, points) {
                editBrand.value = brand_name;
                editSize.value = size;
                editSizeUnit.value = size_unit;
                editWeight.value = weight;
                editWeightUnit.value = weight_unit;
                editBarcode.value = barcode;
                editPoints.value = points;
                editImage.src = imageUrl;
                editModal.style.display = 'block';

                // Link saveEdit function to the save button
                saveEdit.onclick = () => saveEditBottle(id);
            };

            // Save edited bottle
            async function saveEditBottle(id) {
                const brand_name = editBrand.value;
                const size = editSize.value;
                const size_unit = editSizeUnit.value;
                const weight = editWeight.value;
                const weight_unit = editWeightUnit.value;
                const barcode = editBarcode.value;
                const points = editPoints.value;

                try {
                    await window.electronAPI.editPetBottle(id, brand_name, size, size_unit, weight, weight_unit, barcode, points);
                    editModal.style.display = 'none'; // Close modal
                    fetchBottles(); // Refresh the bottles list to reflect the updated data
                } catch (error) {
                    console.error('Error saving bottle:', error);
                    statusDiv.innerText = 'Failed to save bottle';
                }
            }

            // Delete bottle
            window.deleteBottle = async function (id) {
                const confirmDelete = confirm("Are you sure you want to delete this bottle?");
                if (confirmDelete) {
                    try {
                        await window.electronAPI.deletePetBottle(id); // Delete bottle via Electron API
                        fetchBottles(); // Refresh the bottles list after deletion
                    } catch (error) {
                        console.error('Error deleting bottle:', error);
                        statusDiv.innerText = 'Failed to delete bottle';
                    }
                }
            };

            // Event listener for the fetch bottles button
            document.getElementById('fetch-bottles-btn').addEventListener('click', fetchBottles);

            // Event listener for the close button
            closeEditModal.addEventListener('click', () => {
                editModal.style.display = 'none';
            });

            // Fetch bottles on initialization
            fetchBottles();
        }

        //FUNCTION FOR MANAGE CLAIMED REWARDS
        function initializeClaimedRewards() {
            const getDataButton = document.getElementById('get-data');
            const toBeClaimedTableBody = document.querySelector('#to-be-claimed-table tbody');
            const claimedTableBody = document.querySelector('#claimed-table tbody');
            const searchInput = document.getElementById('search-input');
            const scannerStatus = document.getElementById('scanner-status');
            const startScanButton = document.getElementById('start-scan');
            let claimedRewardsData = [];
            let isScanning = false;

            // Fetch and display data in the tables
            async function fetchData() {
                try {
                    const data = await window.electronAPI.getClaimedRewards();
                    claimedRewardsData = data; // Store the data for later use
                    displayTables(data); // Update both tables with fetched data
                } catch (error) {
                    console.error('Error fetching data:', error);
                }
            }

            // Display data in both "to be claimed" and "claimed" tables
            function displayTables(data) {
                // Filter and sort data for each table
                const toBeClaimedRewards = data
                    .filter(reward => reward.status === 'toBeClaimed')
                    .sort((a, b) => new Date(b.claimedAt) - new Date(a.claimedAt));
                console.log('To Be Claimed Rewards:', toBeClaimedRewards);  // Debugging: View "To Be Claimed" rewards

                const claimedRewards = data
                    .filter(reward => reward.status === 'claimed')
                    .sort((a, b) => new Date(b.claimedAt) - new Date(a.claimedAt));
                console.log('Claimed Rewards:', claimedRewards);  // Debugging: View "Claimed" rewards

                // Update tables with sorted data
                updateTable(toBeClaimedTableBody, toBeClaimedRewards, "To Be Claimed Rewards");
                updateTable(claimedTableBody, claimedRewards, "Claimed Rewards");
            }

            // Update table with reward data
            function updateTable(tableBody, data, status) {
                tableBody.innerHTML = '';
                if (data.length === 0) {
                    const row = document.createElement('tr');
                    const colSpan = status === "Claimed Rewards" ? 8 : 9;
                    row.innerHTML = `<td colspan="${colSpan}">No ${status.toLowerCase()} available</td>`;
                    tableBody.appendChild(row);
                    return;
                }

                data.forEach(reward => {
                    const row = document.createElement('tr');
                    if (status === "To Be Claimed Rewards") {
                        row.innerHTML = `
                            <td>${reward.userName}</td>
                            <td>${reward.studentNumber}</td>
                            <td>${reward.barcode}</td>
                            <td>${reward.name}</td>
                            <td>${reward.points}</td>
                            <td>${new Date(reward.claimedAt).toLocaleString()}</td>
                            <td>${reward.status}</td>
                            <td>
                                <button class="status-toggle ${reward.availability === 'Can be Claimed' ? 'can-claim' : 'pending'}" 
                                        data-id="${reward.id}" 
                                        data-current="${reward.availability || 'Pending'}">
                                    ${reward.availability || 'Pending'}
                                </button>
                            </td>
                            <td>
                                <button class="delete-reward" data-id="${reward.id}">Delete</button>
                            </td>
                        `;
                    } else {
                        // Claimed rewards table (without the availability column)
                        row.innerHTML = `
                            <td>${reward.userName}</td>
                            <td>${reward.studentNumber}</td>
                            <td>${reward.barcode}</td>
                            <td>${reward.name}</td>
                            <td>${reward.points}</td>
                            <td>${new Date(reward.claimedAt).toLocaleString()}</td>
                            <td>${reward.status}</td>
                            <td>
                                <button class="delete-reward" data-id="${reward.id}">Delete</button>
                            </td>
                        `;
                    }
                    tableBody.appendChild(row);
                });
                attachEventHandlers(status);
            }

            // Fetch and display data on button click
            getDataButton.addEventListener('click', fetchData);

            // Attach event handlers to delete buttons
            function attachEventHandlers(status) {
                // Delete button handlers
                document.querySelectorAll('.delete-reward').forEach(button => {
                    button.addEventListener('click', async (event) => {
                        const rewardId = event.target.getAttribute('data-id');
                        try {
                            await window.electronAPI.deleteClaimedReward(rewardId);
                            alert('Reward deleted successfully');
                            fetchData();
                        } catch (error) {
                            console.error('Error deleting reward:', error);
                        }
                    });
                });

                // Status toggle button handlers (only for To Be Claimed table)
                if (status === "To Be Claimed Rewards") {
                    document.querySelectorAll('.status-toggle').forEach(button => {
                        button.addEventListener('click', async (event) => {
                            const rewardId = event.target.getAttribute('data-id');
                            const currentStatus = event.target.textContent.trim();
                            const newStatus = currentStatus === 'Pending' ? 'Can be Claimed' : 'Pending';
                            
                            try {
                                await window.electronAPI.updateClaimedRewardAvailability(rewardId, newStatus);
                                // Update button appearance
                                event.target.textContent = newStatus;
                                event.target.className = `status-toggle ${newStatus === 'Can be Claimed' ? 'can-claim' : 'pending'}`;
                                // Refresh data to ensure everything is in sync
                                fetchData();
                            } catch (error) {
                                console.error('Error updating reward status:', error);
                                alert('Failed to update reward status');
                            }
                        });
                    });
                }
            }

            // Search functionality
            searchInput.addEventListener('input', () => {
                const query = searchInput.value.toLowerCase();
                const filteredData = claimedRewardsData.filter(reward => {
                    return reward.name.toLowerCase().includes(query) || reward.barcode.toString().includes(query);
                });
                displayTables(filteredData); // Display only matching results in both tables
            });

            // Barcode scanning functionality
            let barcodeInput = '';
            document.addEventListener('keydown', async (event) => {
                if (isScanning) {
                    if (event.key === 'Enter') {
                        handleBarcodeScan(barcodeInput);
                        barcodeInput = ''; // Reset input
                    } else {
                        barcodeInput += event.key;
                    }
                }
            });

            async function handleBarcodeScan(barcode) {
                const reward = claimedRewardsData.find(reward => reward.barcode === barcode);
                if (reward) {
                    try {
                        const currentTime = new Date().toISOString();
                        await window.electronAPI.updateClaimedRewardStatus(reward.id, 'claimed', currentTime);
                        alert(`Reward with barcode ${barcode} marked as claimed.`);
                        fetchData(); // Refresh tables
                    } catch (error) {
                        console.error('Error updating reward status:', error);
                    }
                } else {
                    alert(`No reward found with barcode ${barcode}.`);
                }
            }

            // Start scanning
            startScanButton.addEventListener('click', () => {
                isScanning = true;
                scannerStatus.textContent = 'Scanner connected. Ready to scan.';
                scannerStatus.style.color = 'green';
            });

            // Fetch rewards on initialization
            fetchData();
        }

        //FUNCTION FOR EDIT USER
        function initializeEditUser(userId) {
            // Fetch user data and populate the form
            (async () => {
                if (userId) {
                    try {
                        const userData = await window.electronAPI.getData();  // Call the correct function
                        const user = userData.find(user => user.id === userId);  // Match the user by ID

                        if (user) {
                            document.getElementById('studentNumber').value = user.studentNumber;
                            document.getElementById('name').value = user.name;
                            document.getElementById('email').value = user.email;
                        } else {
                            console.error('User not found.');
                        }
                    } catch (error) {
                        console.error('Error fetching user data:', error);
                    }
                }
            })();

            const form = document.getElementById('edit-user-form');
            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                const updatedData = {
                    studentNumber: document.getElementById('studentNumber').value,
                    name: document.getElementById('name').value,
                    email: document.getElementById('email').value,
                };

                try {
                    await window.electronAPI.editUser(userId, updatedData.studentNumber, updatedData.name, updatedData.email);
                    alert('User updated successfully');
                    showContent('manage-user');
                } catch (error) {
                    console.error('Error updating user:', error);
                }
            });
        }

        //FUNCTION FOR ADD REWARD
        function initializeAddReward() {
            const addRewardForm = document.getElementById('addRewardForm');

            const handleFormSubmit = async (event) => {
                event.preventDefault();

                const rewardName = document.getElementById('reward_name').value;
                const rewardStock = document.getElementById('stock').value;
                const rewardPoints = document.getElementById('points').value;
                const rewardImage = document.getElementById('image').files[0];

                if (!rewardImage) {
                    alert('Please select an image');
                    return;
                }

                try {
                    // Read the file content
                    const reader = new FileReader();
                    reader.onload = async function (event) {
                        const fileContent = event.target.result;

                        // Upload image to Firebase Storage
                        const { success: uploadSuccess, imageUrl, error: uploadError } = await window.electronAPI.uploadImage({ fileContent, fileName: rewardImage.name });
                        if (!uploadSuccess) {
                            throw new Error(uploadError);
                        }

                        // Save reward details to Firestore
                        const reward = {
                            reward_name: rewardName,
                            stock: rewardStock,
                            points: rewardPoints,
                            image_url: imageUrl
                        };

                        const { success: addSuccess, error: addError } = await window.electronAPI.addReward(reward);
                        if (!addSuccess) {
                            throw new Error(addError);
                        }

                        alert('Reward added successfully');
                        addRewardForm.reset();
                        showContent('redemption-reward');
                    };
                    reader.readAsArrayBuffer(rewardImage);
                } catch (error) {
                    console.error('Error adding reward:', error);
                    alert('Failed to add reward');
                }
            };

            addRewardForm.addEventListener('submit', handleFormSubmit);

            // Ensure the form is reset when navigating back to this page
            window.addEventListener('pageshow', () => {
                addRewardForm.reset();
            });
        }

        //FUNCTION FOR ADD PET BOTTLE
        function initializeAddPetBottle() {
            const addBottleForm = document.getElementById('addBottleForm');

            const handleFormSubmit = async (event) => {
                event.preventDefault();

                const brandName = document.getElementById('brandname').value;
                const bottleSize = document.getElementById('bottleSize').value;
                const bottleSizeUnit = document.getElementById('bottleSizeUnit').value;
                const bottleWeight = document.getElementById('bottleWeight').value;
                const bottleWeightUnit = document.getElementById('bottleWeightUnit').value;
                const barcodeNumber = document.getElementById('barcodenumber').value;
                const points = document.getElementById('points').value;
                const bottleImage = document.getElementById('image').files[0];

                if (!bottleImage) {
                    alert('Please select an image');
                    return;
                }

                try {
                    // Read the file content
                    const reader = new FileReader();
                    reader.onload = async function (event) {
                        const fileContent = event.target.result;

                        // Upload image to Firebase Storage
                        const { success: uploadSuccess, imageUrl, error: uploadError } = await window.electronAPI.uploadPetBottleImage({ fileContent, fileName: bottleImage.name });
                        if (!uploadSuccess) {
                            throw new Error(uploadError);
                        }

                        // Save pet bottle details to Firestore
                        const petBottle = {
                            brand_name: brandName,
                            size: bottleSize,
                            size_unit: bottleSizeUnit,
                            weight: bottleWeight,
                            weight_unit: bottleWeightUnit,
                            barcode_number: barcodeNumber,
                            points: points,
                            image_url: imageUrl
                        };

                        const { success: addSuccess, error: addError } = await window.electronAPI.addPetBottle(petBottle);
                        if (!addSuccess) {
                            throw new Error(addError);
                        }

                        alert('Pet bottle added successfully');
                        addBottleForm.reset();
                        showContent('pet-bottles');
                    };
                    reader.readAsArrayBuffer(bottleImage);
                } catch (error) {
                    console.error('Error adding pet bottle:', error);
                    alert('Failed to add pet bottle');
                }
            };

            addBottleForm.addEventListener('submit', handleFormSubmit);

            // Ensure the form is reset when navigating back to this page
            window.addEventListener('pageshow', () => {
                addBottleForm.reset();
            });
        }

        // Initialize the dashboard on load
        showContent('dashboard');

        async function fetchDashboardData() {
            try {
                const userCount = await window.electronAPI.getUserCount();
                const claimedRewards = await window.electronAPI.getClaimedRewardsCount();
                const bottleContributions = await window.electronAPI.getBottleContributions();

                document.getElementById('user-count').innerText = userCount.total;
                document.getElementById('user-change').innerText = userCount.change > 0 ? `â†‘ ${userCount.change}%` : `â†“ ${Math.abs(userCount.change)}%`;
                document.getElementById('user-change').classList.toggle('positive', userCount.change > 0);
                document.getElementById('user-change').classList.toggle('negative', userCount.change < 0);

                document.getElementById('claimed-rewards-count').innerText = claimedRewards.total;
                document.getElementById('rewards-change').innerText = claimedRewards.change > 0 ? `â†‘ ${claimedRewards.change}%` : `â†“ ${Math.abs(claimedRewards.change)}%`;
                document.getElementById('rewards-change').classList.toggle('positive', claimedRewards.change > 0);
                document.getElementById('rewards-change').classList.toggle('negative', claimedRewards.change < 0);

                document.getElementById('bottle-count').innerText = bottleContributions.total;
                document.getElementById('bottle-change').innerText = bottleContributions.change > 0 ? `â†‘ ${bottleContributions.change}%` : `â†“ ${Math.abs(bottleContributions.change)}%`;
                document.getElementById('bottle-change').classList.toggle('positive', bottleContributions.change > 0);
                document.getElementById('bottle-change').classList.toggle('negative', bottleContributions.change < 0);
            } catch (error) {
                console.error('Error fetching dashboard data:', error);
            }
        }

        // Call this function when the dashboard is loaded
        fetchDashboardData();

        //Move loadReports outside of initializeReports
        async function loadReports() {
            const reportsList = document.getElementById('reports-list');
            const statusFilter = document.getElementById('status-filter');
            const categoryFilter = document.getElementById('category-filter');

            try {
                const reports = await window.electronAPI.getReports();
                
                // Apply filters
                const filteredReports = reports.filter(report => {
                    const statusMatch = statusFilter.value === 'all' || report.status === statusFilter.value;
                    const categoryMatch = categoryFilter.value === 'all' || report.category === categoryFilter.value;
                    return statusMatch && categoryMatch;
                });

                // Sort reports by date (newest first)
                filteredReports.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                reportsList.innerHTML = filteredReports.map(report => `
                    <div class="report-card ${report.status}">
                        <div class="report-header">
                            <div class="report-info">
                                <span class="report-status ${report.status}">${report.status}</span>
                                <span class="report-category">${getCategoryLabel(report.category)}</span>
                            </div>
                            <span class="report-date">${new Date(report.createdAt).toLocaleDateString()}</span>
                        </div>
                        <div class="report-description">${report.description}</div>
                        ${report.adminResponse ? `
                            <div class="admin-response">
                                <strong>Admin Response:</strong> ${report.adminResponse}
                            </div>
                        ` : ''}
                        ${report.status !== 'resolved' ? `
                            <div class="report-actions">
                                ${report.status === 'pending' ? `
                                    <button onclick="updateReportStatus('${report.id}', 'in-progress')">
                                        Mark In Progress
                                    </button>
                                ` : ''}
                                <button onclick="updateReportStatus('${report.id}', 'resolved')">
                                    Resolve
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading reports:', error);
                reportsList.innerHTML = `
                    <div class="error-message">
                        Failed to load reports. Please try again later.
                    </div>
                `;
            }
        }

        async function initializeReports() {
            const statusFilter = document.getElementById('status-filter');
            const categoryFilter = document.getElementById('category-filter');

            // Add the CSS for the reports section
            const style = document.createElement('style');
            style.textContent = `
                .reports-container {
                    padding: 20px;
                    max-width: 1200px;
                    margin: 0 auto;
                }

                .reports-filters {
                    display: flex;
                    gap: 15px;
                    margin-bottom: 20px;
                }

                .reports-filters select {
                    padding: 8px;
                    border-radius: 4px;
                    border: 1px solid #ddd;
                }

                .report-card {
                    background: white;
                    border-radius: 8px;
                    padding: 15px;
                    margin-bottom: 15px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }

                .report-card.pending {
                    border-left: 4px solid #ff9800;
                }

                .report-card.in-progress {
                    border-left: 4px solid #2196f3;
                }

                .report-card.resolved {
                    border-left: 4px solid #4caf50;
                }

                .report-header {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 10px;
                }

                .report-status {
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 12px;
                    font-weight: bold;
                }

                .report-status.pending { background: #fff3e0; color: #f57c00; }
                .report-status.in-progress { background: #e3f2fd; color: #1976d2; }
                .report-status.resolved { background: #e8f5e9; color: #388e3c; }

                .report-category {
                    font-weight: 500;
                    color: #666;
                }

                .report-description {
                    margin: 15px 0;
                    line-height: 1.5;
                }

                .admin-response {
                    background: #f5f5f5;
                    padding: 10px;
                    border-radius: 4px;
                    margin-top: 10px;
                }

                .report-actions {
                    display: flex;
                    gap: 10px;
                    margin-top: 15px;
                }

                .report-actions button {
                    padding: 8px 16px;
                    border-radius: 4px;
                    border: none;
                    cursor: pointer;
                    font-weight: 500;
                }

                .report-actions button:first-child {
                    background: #2196f3;
                    color: white;
                }

                .report-actions button:last-child {
                    background: #4caf50;
                    color: white;
                }

                .report-actions button:disabled {
                    background: #ccc;
                    cursor: not-allowed;
                }
            `;
            document.head.appendChild(style);

            // Initialize filters
            statusFilter.addEventListener('change', loadReports);
            categoryFilter.addEventListener('change', loadReports);

            // Load initial reports
            await loadReports();
        }

        // Helper function to get category label
        function getCategoryLabel(category) {
            const categories = {
                performance: 'App Performance',
                rewards: 'Reward Issues',
                account: 'Account Problems',
                points: 'Points/Bottles Issues',
                other: 'Other'
            };
            return categories[category] || category;
        }

        // Function to update report status
        async function updateReportStatus(reportId, status) {
            try {
                // Add SweetAlert2 prompt for admin response
                const { value: adminResponse } = await Swal.fire({
                    title: 'Admin Response',
                    input: 'textarea',
                    inputLabel: 'Add your response (optional)',
                    inputPlaceholder: 'Type your response here...',
                    showCancelButton: true,
                    confirmButtonColor: '#83951c',
                    cancelButtonColor: '#d33'
                });

                // Even if no response is provided, we'll send an empty string instead of undefined
                const response = adminResponse || '';
                
                const result = await window.electronAPI.updateReport(reportId, status, response);
                
                if (result.success) {
                    await Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: `Report ${status === 'in-progress' ? 'marked as in progress' : 'resolved'} successfully`,
                        confirmButtonColor: '#83951c'
                    });
                    // Refresh the reports list
                    loadReports();
                } else {
                    throw new Error('Failed to update report');
                }
            } catch (error) {
                console.error('Error updating report:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: `Failed to ${status === 'in-progress' ? 'mark as in progress' : 'resolve'} the report`,
                    confirmButtonColor: '#83951c'
                });
            }
        }

        // Remove the separate resolveReport function and update the button onclick
        function resolveReport(reportId) {
            updateReportStatus(reportId, 'resolved');
        }

        // Add this function after the existing showContent switch case for 'sales'
        async function initializeSales() {
            try {
                // Get and display total revenue
                const totalRevenue = await window.electronAPI.calculateTotalRevenue();
                document.getElementById('total-revenue').textContent = `â‚±${totalRevenue.toFixed(2)}`;

                // Get and display total bottles
                const totalBottles = await window.electronAPI.getTotalBottleCount();
                document.getElementById('total-bottles').textContent = totalBottles;

                // Get transactions for average daily sales calculation
                const transactions = await window.electronAPI.getBottleTransactions();
                
                // Calculate average daily sales
                const avgDailySales = calculateAverageDailySales(transactions);
                document.getElementById('avg-daily-sales').textContent = `â‚±${avgDailySales.toFixed(2)}`;

                // Display transactions in table
                updateSalesTable(transactions);

                // Setup filters
                setupSalesFilters(transactions);
            } catch (error) {
                console.error('Error initializing sales:', error);
            }
        }

        function calculateAverageDailySales(transactions) {
            if (!transactions || transactions.length === 0) return 0;

            // Group transactions by date and sum their amounts
            const dailySales = {};
            
            transactions.forEach(transaction => {
                const date = new Date(transaction.date).toISOString().split('T')[0];
                if (!dailySales[date]) {
                    dailySales[date] = 0;
                }
                dailySales[date] += transaction.amount;
            });

            // Calculate the average
            const totalSales = Object.values(dailySales).reduce((sum, amount) => sum + amount, 0);
            const numberOfDays = Object.keys(dailySales).length;

            return numberOfDays > 0 ? totalSales / numberOfDays : 0;
        }

        function updateSalesTable(transactions) {
            const tbody = document.querySelector('#sales-table tbody');
            tbody.innerHTML = '';

            transactions.forEach(transaction => {
                const formattedDate = new Date(transaction.date).toLocaleDateString();
                const formattedAmount = transaction.amount.toFixed(2);
                const formattedWeight = transaction.totalWeight ? parseFloat(transaction.totalWeight).toFixed(2) : '0.00';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${transaction.transactionId}</td>
                    <td>${formattedDate}</td>
                    <td>${transaction.studentNumber}</td>
                    <td>${transaction.name}</td>
                    <td>${transaction.bottleCount}</td>
                    <td>${formattedWeight}</td>
                    <td>${transaction.points}</td>
                    <td>â‚±${formattedAmount}</td>
                    <td><span class="status-badge status-completed">Completed</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        // Add these sorting and filtering functions
        let currentSortColumn = null;
        let isAscending = true;

        function setupSalesFilters(transactions) {
            const searchInput = document.getElementById('sales-search');
            const dateFrom = document.getElementById('date-from');
            const dateTo = document.getElementById('date-to');

            // Add event listeners for filters
            searchInput.addEventListener('input', () => filterAndSortTransactions(transactions));
            dateFrom.addEventListener('change', () => filterAndSortTransactions(transactions));
            dateTo.addEventListener('change', () => filterAndSortTransactions(transactions));

            // Add export button click handler
            document.querySelector('.export-btn').addEventListener('click', exportToExcel);

            // Add click handlers for table headers
            const headers = document.querySelectorAll('#sales-table th');
            headers.forEach((header, index) => {
                header.style.cursor = 'pointer';
                header.addEventListener('click', () => {
                    // Toggle sort direction if clicking the same column
                    if (currentSortColumn === index) {
                        isAscending = !isAscending;
                    } else {
                        currentSortColumn = index;
                        isAscending = true;
                    }
                    filterAndSortTransactions(transactions);
                    
                    // Update sort indicators
                    headers.forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
                    header.classList.add(isAscending ? 'sorted-asc' : 'sorted-desc');
                });
            });
        }

        function filterAndSortTransactions(transactions) {
            let filtered = filterTransactions(transactions);
            if (currentSortColumn !== null) {
                filtered = sortTransactions(filtered, currentSortColumn, isAscending);
            }
            updateSalesTable(filtered);
        }

        function filterTransactions(transactions) {
            const searchTerm = document.getElementById('sales-search').value.toLowerCase();
            const dateFrom = document.getElementById('date-from').value;
            const dateTo = document.getElementById('date-to').value;

            return transactions.filter(transaction => {
                // Search filter
                const matchesSearch = 
                    transaction.transactionId.toLowerCase().includes(searchTerm) ||
                    transaction.studentNumber.toLowerCase().includes(searchTerm) ||
                    transaction.name.toLowerCase().includes(searchTerm);

                // Date filter
                const transactionDate = new Date(transaction.date).toISOString().split('T')[0];
                const matchesDate = (!dateFrom || transactionDate >= dateFrom) && 
                                   (!dateTo || transactionDate <= dateTo);

                return matchesSearch && matchesDate;
            });
        }

        function sortTransactions(transactions, columnIndex, ascending) {
            return [...transactions].sort((a, b) => {
                let valueA, valueB;

                // Determine which values to compare based on column index
                switch(columnIndex) {
                    case 0: // Transaction ID
                        valueA = a.transactionId;
                        valueB = b.transactionId;
                        break;
                    case 1: // Date
                        valueA = new Date(a.date).getTime();
                        valueB = new Date(b.date).getTime();
                        break;
                    case 2: // Student Number
                        valueA = a.studentNumber;
                        valueB = b.studentNumber;
                        break;
                    case 3: // Name
                        valueA = a.name;
                        valueB = b.name;
                        break;
                    case 4: // Bottle Count
                        valueA = a.bottleCount;
                        valueB = b.bottleCount;
                        break;
                    case 5: // Weight
                        valueA = parseFloat(a.totalWeight) || 0;
                        valueB = parseFloat(b.totalWeight) || 0;
                        break;
                    case 6: // Points
                        valueA = a.points;
                        valueB = b.points;
                        break;
                    case 7: // Amount
                        valueA = a.amount;
                        valueB = b.amount;
                        break;
                    default:
                        return 0;
                }

                // Compare the values
                if (valueA < valueB) return ascending ? -1 : 1;
                if (valueA > valueB) return ascending ? 1 : -1;
                return 0;
            });
        }

        function exportToExcel() {
            try {
                // Get the table data
                const table = document.getElementById('sales-table');
                const rows = Array.from(table.querySelectorAll('tr'));

                // Convert table data to worksheet format
                const data = rows.map(row => {
                    return Array.from(row.querySelectorAll('th, td')).map(cell => {
                        // Remove the peso sign and any other formatting
                        let value = cell.textContent.replace('â‚±', '').trim();
                        // Convert to number if possible
                        return isNaN(value) ? value : parseFloat(value);
                    });
                });

                // Create workbook and worksheet
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Sales Data');

                // Generate filename with current date
                const date = new Date().toISOString().split('T')[0];
                const fileName = `sales_report_${date}.xlsx`;

                // Save the file
                XLSX.writeFile(wb, fileName);
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('Error exporting to Excel. Please try again.');
            }
        }

        async function initializeDashboardCharts() {
            try {
                // Fetch all necessary data
                const transactions = await window.electronAPI.getBottleTransactions();
                const totalRevenue = await window.electronAPI.calculateTotalRevenue();
                const totalBottles = await window.electronAPI.getTotalBottleCount();
                const totalWeight = await window.electronAPI.getTotalBottleWeight();

                // Update statistics
                document.getElementById('total-revenue').textContent = `â‚±${totalRevenue.toFixed(2)}`;
                document.getElementById('total-bottles').textContent = totalBottles;
                document.getElementById('total-weight').textContent = `${totalWeight}g`;

                // Initialize Revenue Chart with fixed dimensions
                const revenueCtx = document.getElementById('revenueChart').getContext('2d');
                const revenueData = processRevenueData(transactions);
                
                new Chart(revenueCtx, {
                    type: 'line',
                    data: {
                        labels: revenueData.labels,
                        datasets: [
                            {
                                label: 'Revenue',
                                data: revenueData.revenue,
                                borderColor: '#7a9b57',
                                backgroundColor: 'rgba(122, 155, 87, 0.1)',
                                tension: 0.4,
                                fill: true,
                                pointBackgroundColor: '#7a9b57',
                                pointRadius: 4,
                                pointHoverRadius: 6
                            },
                            {
                                label: 'Target',
                                data: revenueData.target,
                                borderColor: '#ffa726',
                                backgroundColor: 'rgba(255, 167, 38, 0.1)',
                                tension: 0.4,
                                fill: true,
                                pointBackgroundColor: '#ffa726',
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true, // Changed to true
                        height: 350, // Fixed height
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(255, 255, 255, 0.9)',
                                titleColor: '#333',
                                bodyColor: '#666',
                                borderColor: '#ddd',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: true,
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: â‚±${context.parsed.y.toFixed(2)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    font: {
                                        size: 12
                                    },
                                    callback: function(value) {
                                        return 'â‚±' + value.toFixed(2);
                                    }
                                }
                            }
                        }
                    }
                });

                // Initialize Bottle Distribution Chart
                const bottleCtx = document.getElementById('bottleDistributionChart').getContext('2d');
                const bottleData = processBottleData(transactions);
                new Chart(bottleCtx, {
                    type: 'bar',
                    data: {
                        labels: bottleData.labels,
                        datasets: [{
                            label: 'Bottles Collected',
                            data: bottleData.data,
                            backgroundColor: '#7a9b57'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });

                // Initialize Contributors Chart
                const contributorsCtx = document.getElementById('contributorsChart').getContext('2d');
                const contributorsData = processContributorsData(transactions);
                new Chart(contributorsCtx, {
                    type: 'doughnut',
                    data: {
                        labels: contributorsData.labels,
                        datasets: [{
                            data: contributorsData.data,
                            backgroundColor: ['#7a9b57', '#ffa726', '#42a5f5', '#ef5350', '#66bb6a']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });

                // Update progress circle
                updateProgressCircle(totalWeight);
            } catch (error) {
                console.error('Error initializing dashboard charts:', error);
            }
        }

        function processRevenueData(transactions) {
            // Group transactions by date and calculate daily revenue
            const dailyRevenue = {};
            const dailyTarget = {};
            
            // Set target revenue (you can adjust this value)
            const targetPerDay = 1000; // â‚±1000 per day

            transactions.forEach(transaction => {
                const date = new Date(transaction.date).toISOString().split('T')[0];
                if (!dailyRevenue[date]) {
                    dailyRevenue[date] = 0;
                }
                dailyRevenue[date] += transaction.amount || 0;
                dailyTarget[date] = targetPerDay;
            });

            // Get last 7 days
            const dates = [];
            const revenue = [];
            const target = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const formattedDate = date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                dates.push(formattedDate);
                revenue.push(dailyRevenue[dateStr] || 0);
                target.push(targetPerDay);
            }

            return {
                labels: dates,
                revenue: revenue,
                target: target
            };
        }

        function processBottleData(transactions) {
            // Process transactions to get bottle collection data
            // Return formatted data for the chart
            return {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                data: [65, 59, 80, 81, 56, 55, 40]
            };
        }

        function processContributorsData(transactions) {
            // Process transactions to get top contributors
            // Return formatted data for the chart
            return {
                labels: ['User A', 'User B', 'User C', 'User D', 'Others'],
                data: [30, 25, 20, 15, 10]
            };
        }

        function updateProgressCircle(totalWeight) {
            const target = 20000; // 20kg in grams
            const progress = (totalWeight / target) * 100;
            const progressText = document.getElementById('progress-text');
            const progressDescription = document.getElementById('progress-description');
            
            progressText.textContent = `${Math.min(100, progress.toFixed(1))}%`;
            progressDescription.textContent = `Total Weight: ${totalWeight}g / ${target}g`;
        }
    </script>
</body>

</html>